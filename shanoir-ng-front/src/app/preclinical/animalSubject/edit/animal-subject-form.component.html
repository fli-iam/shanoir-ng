<!--
Shanoir NG - Import, manage and share neuroimaging data
Copyright (C) 2009-2019 Inria - https://www.inria.fr/
Contact us on https://project.inria.fr/shanoir/

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

You should have received a copy of the GNU General Public License
along with this program. If not, see https://www.gnu.org/licenses/gpl-3.0.html
-->

<div #formContainer class="content-component detail" [@preventInitialChildAnimations]>
    @if (form) {
        <form [formGroup]="form" class="max-content" novalidate [class.disabled]="footerState.loading">
            <div class="layout" [ngClass]="{ left: mode == 'view' }">
                <form-footer
                    [state]="footerState"
                    (save)="save()"
                    (edit)="goToEdit()"
                    (delete)="deleteBySubject(entity.subject)"
                    (dismiss)="goToView(entity.animalSubject.id)"
                    (back)="goBack()">
                    @if (mode == "view" && hasDownloadRight) {
                        <button
                            class="right-icon dl-button"
                            type="button"
                            (click)="download()"
                            [disabled]="downloadState.isActive()">
                            Download
                            <i class="fas fa-download"></i>
                        </button>
                    }
                </form-footer>
                <span>
                    @switch (mode) {
                        @case ("view") {
                            <h2 class="header command-zone" i18n="View subject|Title@@subjectDetailViewTitle">
                                Details on subject
                            </h2>
                        }
                        @case ("edit") {
                            <h2 class="header command-zone" i18n="Edit subject|Title@@subjectDetailEditTitle">
                                Edit subject
                            </h2>
                        }
                        @case ("create") {
                            <h2 class="header command-zone" i18n="Create subject|Title@@subjectDetailCreateTitle">
                                Create subject
                            </h2>
                        }
                    }
                </span>
                <!-- Subject properties group -->
                <fieldset formGroupName="subject">
                    @if (mode !== "view") {
                        <legend i18n="Subject detail|Name label@@subjectDetailGeneral">General</legend>
                    }
                    <ol>
                        <li>
                            <label
                                i18n="
                                    Subject detail|Subject Imaged object category
                                    label@@SubjectDetailSubjectImagedObjectCategory">
                                Imaged object category
                            </label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("view") {
                                        {{ preclinicalSubject.subject.imagedObjectCategory }}
                                    }
                                    @default {
                                        <select-box
                                            formControlName="imagedObjectCategory"
                                            [options]="catOptions"></select-box>
                                        @if (hasError("subject.imagedObjectCategory", ["required"])) {
                                            <label
                                                class="form-validation-alert"
                                                i18n="
                                                    Subject detail|ImagedObjectCategory required
                                                    error@@subjectDetailImagedObjectCategoryRequiredError">
                                                Imaged object category is required!
                                            </label>
                                        }
                                    }
                                }
                            </span>
                        </li>
                        <li>
                            <label i18n="Edit subject|Name label">Common name</label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("create") {
                                        <input type="text" id="name" formControlName="name" />
                                        @if (hasError("subject.name", ["required"])) {
                                            <label
                                                class="form-validation-alert"
                                                i18n="
                                                    Subject detail|Name required error@@subjectDetailNameRequiredError">
                                                Common Name is required !
                                            </label>
                                        }
                                        @if (hasError("subject.name", ["minlength", "maxlength"])) {
                                            <label
                                                class="form-validation-alert"
                                                i18n="Subject detail|Name Length error@@subjectDetailNameLengthError">
                                                Length must be between 2 and 64 !
                                            </label>
                                        }
                                        @if (hasError("subject.name", ["unique"])) {
                                            <label
                                                class="form-validation-alert"
                                                i18n="Subject detail|Name unique error@@subjectDetailNameUniqueError">
                                                This name is already taken !
                                            </label>
                                        }
                                    }
                                    @default {
                                        {{ preclinicalSubject?.subject?.name }}
                                    }
                                }
                            </span>
                        </li>
                        @if (animalSelected()) {
                            <li [@slideDown]="animalSelected()">
                                <label i18n="Subject detail|Sex label@@subjectDetailSex">Sex</label>
                                <span class="right-col">
                                    @switch (mode) {
                                        @case ("view") {
                                            <div>
                                                @switch (preclinicalSubject.subject.sex) {
                                                    @case ("F") {
                                                        Female
                                                    }
                                                    @case ("M") {
                                                        Male
                                                    }
                                                    @default {
                                                        {{ preclinicalSubject?.subject?.sex }}
                                                    }
                                                }
                                            </div>
                                        }
                                        @default {
                                            <select-box formControlName="sex" [options]="genderOptions"></select-box>
                                        }
                                    }
                                </span>
                            </li>
                        }
                    </ol>
                </fieldset>
                <!-- Animal subject properties group -->
                @if (animalSelected()) {
                    <fieldset formGroupName="animalSubject" [@slideDown]="animalSelected()">
                        @if (mode !== "view") {
                            <legend i18n="Animal subject detail|Animal properties@@animalSubjectDetailAnimal">
                                Animal Properties
                            </legend>
                        }
                        <ol>
                            <li>
                                <label i18n="Edit subject|Specie label">Species</label>
                                <span class="right-col">
                                    @switch (mode) {
                                        @case ("view") {
                                            {{ preclinicalSubject?.animalSubject?.specie?.value }}
                                        }
                                        @default {
                                            <select-box
                                                (newClick)="goToRefPage('subject', 'specie')"
                                                formControlName="specie"
                                                [optionArr]="species"></select-box>
                                            @if (hasError("animalSubject.specie", ["required"])) {
                                                <label
                                                    [@slideDown]="hasError('animalSubject.specie', ['required'])"
                                                    class="form-validation-alert"
                                                    i18n="
                                                        Edit subjectSpecie|Specie required
                                                        error@@animalSubjectDetailSpecieRequiredError">
                                                    Species is required!
                                                </label>
                                            }
                                        }
                                    }
                                </span>
                            </li>
                            <li>
                                <label i18n="Edit subject|Strain label">Strain</label>
                                <span class="right-col">
                                    @switch (mode) {
                                        @case ("view") {
                                            {{ preclinicalSubject?.animalSubject?.strain?.value }}
                                        }
                                        @default {
                                            <select-box
                                                (newClick)="goToRefPage('subject', 'strain')"
                                                formControlName="strain"
                                                [optionArr]="strains"></select-box>
                                            @if (hasError("animalSubject.strain", ["required"])) {
                                                <label
                                                    [@slideDown]="hasError('animalSubject.strain', ['required'])"
                                                    class="form-validation-alert"
                                                    i18n="
                                                        Edit subjectStrain|Strain required
                                                        error@@animalSubjectDetailStrainRequiredError">
                                                    Strain is required!
                                                </label>
                                            }
                                        }
                                    }
                                </span>
                            </li>
                            <li>
                                <label i18n="Edit subject|Biotype label">Biological type</label>
                                <span class="right-col">
                                    @switch (mode) {
                                        @case ("view") {
                                            {{ preclinicalSubject?.animalSubject?.biotype?.value }}
                                        }
                                        @default {
                                            <select-box
                                                (newClick)="goToRefPage('subject', 'biotype')"
                                                formControlName="biotype"
                                                [optionArr]="biotypes"></select-box>
                                            @if (hasError("animalSubject.biotype", ["required"])) {
                                                <label
                                                    [@slideDown]="hasError('animalSubject.biotype', ['required'])"
                                                    class="form-validation-alert"
                                                    i18n="
                                                        Edit subjectBiotype|Biotype required
                                                        error@@animalSubjectDetailBiotypeRequiredError">
                                                    Biological type is required!
                                                </label>
                                            }
                                        }
                                    }
                                </span>
                            </li>
                            <li>
                                <label i18n="Edit subject|Provider label">Provider</label>
                                <span class="right-col">
                                    @switch (mode) {
                                        @case ("view") {
                                            {{ preclinicalSubject?.animalSubject?.provider?.value }}
                                        }
                                        @default {
                                            <select-box
                                                (newClick)="goToRefPage('subject', 'provider')"
                                                formControlName="provider"
                                                [optionArr]="providers"></select-box>
                                            @if (hasError("animalSubject.provider", ["required"])) {
                                                <label
                                                    [@slideDown]="hasError('animalSubject.provider', ['required'])"
                                                    class="form-validation-alert"
                                                    i18n="
                                                        Edit subjectProvider|Provider required
                                                        error@@animalSubjectDetailProviderRequiredError">
                                                    Provider is required!
                                                </label>
                                            }
                                        }
                                    }
                                </span>
                            </li>
                            <li>
                                <label i18n="Edit subject|Stabulation label">Stabulation</label>
                                <span class="right-col">
                                    @switch (mode) {
                                        @case ("view") {
                                            {{ preclinicalSubject?.animalSubject?.stabulation?.value }}
                                        }
                                        @default {
                                            <select-box
                                                (newClick)="goToRefPage('subject', 'stabulation')"
                                                formControlName="stabulation"
                                                [optionArr]="stabulations"></select-box>
                                            @if (hasError("animalSubject.stabulation", ["required"])) {
                                                <label
                                                    [@slideDown]="hasError('animalSubject.stabulation', ['required'])"
                                                    class="form-validation-alert"
                                                    i18n="
                                                        Edit subjectStabulation|Stabulation required
                                                        error@@animalSubjectDetailStabulationRequiredError">
                                                    Stabulation is required!
                                                </label>
                                            }
                                        }
                                    }
                                </span>
                            </li>
                        </ol>
                    </fieldset>
                }
                <!-- Study -->
                <fieldset formGroupName="subject">
                    <legend>Study</legend>
                    <ol>
                        <li>
                            <label>Study</label>
                            <span class="right-col">
                                {{ preclinicalSubject?.subject?.study?.name }}
                            </span>
                        </li>
                    </ol>
                    @if (preclinicalSubject.subject.identifier != null) {
                        <ol>
                            <li>
                                <label>Subject identifier for this study</label>
                                <span class="right-col">
                                    {{ preclinicalSubject.subject.identifier }}
                                </span>
                            </li>
                        </ol>
                    }
                    <ol>
                        <li>
                            <label>Tags</label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("view") {
                                        @for (tag of preclinicalSubject.subject.tags; track tag) {
                                            <span
                                                class="tag"
                                                [class.dark]="getFontColor(tag.color)"
                                                [style.background]="tag.color">
                                                {{ tag.name }}
                                            </span>
                                        }
                                    }
                                    @default {
                                        <tag-list
                                            [availableTags]="preclinicalSubject.subject.study?.tags"
                                            formControlName="tags"></tag-list>
                                    }
                                }
                            </span>
                        </li>
                    </ol>
                    <ol class="subject-study">
                        <div>
                            <li>
                                <label>Subject type</label>
                                <span class="right-col">
                                    @switch (mode) {
                                        @case ("view") {
                                            {{ preclinicalSubject.subject.subjectType }}
                                        }
                                        @default {
                                            <select-box
                                                formControlName="subjectType"
                                                [options]="subjectTypes"></select-box>
                                        }
                                    }
                                </span>
                            </li>
                            <li>
                                <label>Physically involved</label>
                                <span class="right-col">
                                    @switch (mode) {
                                        @case ("view") {
                                            @if (preclinicalSubject.subject.physicallyInvolved) {
                                                <span class="bool-true"><i class="fas fa-check"></i></span>
                                            }
                                            @if (!preclinicalSubject.subject.physicallyInvolved) {
                                                <span class="bool-false"><i class="fas fa-times"></i></span>
                                            }
                                        }
                                        @default {
                                            <checkbox formControlName="physicallyInvolved"></checkbox>
                                        }
                                    }
                                </span>
                            </li>
                        </div>
                    </ol>
                </fieldset>
                <!-- Pathologies and therapies sections -->
            </div>
            @if (displayPathologyTherapy) {
                <div>
                    <fieldset>
                        <legend i18n="AnimalSubjectDetail|Pathologies label@@animalSubjectDetailPathologies">
                            Pathologies
                        </legend>
                        <subject-pathology-list [mode]="mode" formControlName="pathologies"></subject-pathology-list>
                    </fieldset>
                    <fieldset>
                        <legend i18n="AnimalSubjectDetail|Therapies label@@animalSubjectDetailTherapies">
                            Therapies
                        </legend>
                        <subject-therapy-list [mode]="mode" formControlName="therapies"></subject-therapy-list>
                    </fieldset>
                </div>
            }
        </form>
    }
</div>
