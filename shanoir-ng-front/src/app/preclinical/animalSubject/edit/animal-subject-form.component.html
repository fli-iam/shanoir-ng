<!--
Shanoir NG - Import, manage and share neuroimaging data
Copyright (C) 2009-2019 Inria - https://www.inria.fr/
Contact us on https://project.inria.fr/shanoir/

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

You should have received a copy of the GNU General Public License
along with this program. If not, see https://www.gnu.org/licenses/gpl-3.0.html
-->

<div #formContainer class="content-component detail" [@preventInitialChildAnimations]>
    <form *ngIf="form" [formGroup]="form" class="max-content" novalidate [class.disabled]="footerState.loading">
        <div class="layout" [ngClass]="{'left': mode=='view'}">
            <form-footer
                    [state]="footerState"
                    (save)="save()"
                    (edit)="goToEdit()"
                    (delete) = "deleteBySubject(entity.subject)"
                    (dismiss)="goToView(entity.id)"
                    (back)="goBack()">
            <button  *ngIf="mode == 'view' && hasDownloadRight" class="right-icon dl-button" type="button" (click)="download()" [disabled]="downloadState.isActive()">Download<i class="fas fa-download"></i></button>
            </form-footer>
            <span [ngSwitch]="mode">
                <ng-template [ngSwitchCase]="'view'">
                    <h2 class="header command-zone"i18n="View subject|Title@@subjectDetailViewTitle">Details on subject</h2>
                </ng-template>
                <ng-template [ngSwitchCase]="'edit'">
                    <h2 class="header command-zone"i18n="Edit subject|Title@@subjectDetailEditTitle">Edit subject</h2>
                </ng-template>
                <ng-template [ngSwitchCase]="'create'">
                    <h2 class="header command-zone"i18n="Create subject|Title@@subjectDetailCreateTitle">Create subject</h2>
                </ng-template>
            </span>
            
            <!-- Subject properties group -->
            <fieldset formGroupName="subject">
                <legend *ngIf="mode !== 'view'" i18n="Subject detail|Name label@@subjectDetailGeneral">General</legend>
                <ol>
                    <li>
                        <label i18n="Subject detail|Subject Imaged object category label@@SubjectDetailSubjectImagedObjectCategory">Imaged object category</label>
                        <span class="right-col" [ngSwitch]="mode">
                            <ng-template [ngSwitchCase]="'view'">
                                {{animalSubject.subject.imagedObjectCategory}}
                            </ng-template>
                            <ng-template ngSwitchDefault>
                                <select-box formControlName="imagedObjectCategory" [options]="catOptions">
                                </select-box>
                                <label *ngIf="hasError('subject.imagedObjectCategory', ['required'])" class="form-validation-alert" i18n="Subject detail|ImagedObjectCategory required error@@subjectDetailImagedObjectCategoryRequiredError">Imaged object category is required!</label>
                            </ng-template>
                        </span>
                    </li>
                    <li>
                        <label i18n="Edit subject|Name label">Common name</label>
                        <span class="right-col">
                            @switch (mode) {
                                @case ('create') {
                                    <input type="text" id="name" formControlName="name"/>
                                    <label *ngIf="hasError('subject.name', ['required'])" class="form-validation-alert" i18n="Subject detail|Name required error@@subjectDetailNameRequiredError">Common Name is required !</label>
                                    <label *ngIf="hasError('subject.name', ['minlength', 'maxlength'])" class="form-validation-alert" i18n="Subject detail|Name Length error@@subjectDetailNameLengthError">Length must be between 2 and 64 !</label>
                                    <label *ngIf="hasError('subject.name', ['unique'])" class="form-validation-alert" i18n="Subject detail|Name unique error@@subjectDetailNameUniqueError">This name is already taken !</label>
                                }
                                @default {
                                    {{animalSubject?.subject?.name}}
                                }
                            }
                        </span>
                    </li>
                    <li *ngIf="animalSelected()" [@slideDown]="animalSelected()">
                        <label i18n="Subject detail|Sex label@@subjectDetailSex">Sex</label>
                        <span class="right-col" [ngSwitch]="mode">
                            <ng-template [ngSwitchCase]="'view'">
                                <div [ngSwitch]="animalSubject.subject.sex">
                                    <ng-template [ngSwitchCase]="'F'">Female</ng-template>
                                    <ng-template [ngSwitchCase]="'M'">Male</ng-template>
                                    <ng-template ngSwitchDefault>{{animalSubject?.subject?.sex}}</ng-template>
                                </div>
                            </ng-template>
                            <ng-template ngSwitchDefault>
                                <select-box formControlName="sex" [options]="genderOptions">
                                </select-box>
                            </ng-template>
                        </span>
                    </li>
                </ol>
            </fieldset>

            <!-- Animal subject properties group -->
            <fieldset *ngIf="animalSelected()" [@slideDown]="animalSelected()">
                <legend *ngIf="mode !== 'view'" i18n="Animal subject detail|Animal properties@@animalSubjectDetailAnimal">Animal Properties</legend>
                <ol>
                    <li>
                        <label i18n="Edit subject|Specie label">Species</label>
                        <span class="right-col" [ngSwitch]="mode">
                            <ng-template [ngSwitchCase]="'view'">
                                    {{animalSubject?.specie?.value}}
                            </ng-template>
                            <ng-template ngSwitchDefault>
                                <select-box (newClick)="goToRefPage('subject','specie')" formControlName="specie" [optionArr]="species">
                                </select-box>
                                <label *ngIf="hasError('animalSubject.specie', ['required'])" [@slideDown]="hasError('animalSubject.specie', ['required'])" class="form-validation-alert" i18n="Edit subjectSpecie|Specie required error@@animalSubjectDetailSpecieRequiredError">Species is required!</label>
                            </ng-template>
                        </span>
                    </li>
                    <li>
                        <label i18n="Edit subject|Strain label">Strain</label>
                        <span class="right-col" [ngSwitch]="mode">
                            <ng-template [ngSwitchCase]="'view'">
                                    {{animalSubject?.strain?.value}}
                            </ng-template>
                            <ng-template ngSwitchDefault>
                                <select-box (newClick)="goToRefPage('subject','strain')" formControlName="strain" [optionArr]="strains">
                                </select-box>
                                <label *ngIf="hasError('animalSubject.strain', ['required'])" [@slideDown]="hasError('animalSubject.strain', ['required'])" class="form-validation-alert" i18n="Edit subjectStrain|Strain required error@@animalSubjectDetailStrainRequiredError">Strain is required!</label>
                            </ng-template>
                        </span>
                    </li>
                    <li>
                        <label i18n="Edit subject|Biotype label">Biological type</label>
                        <span class="right-col" [ngSwitch]="mode">
                            <ng-template [ngSwitchCase]="'view'">
                                    {{animalSubject?.biotype?.value}}
                            </ng-template>
                            <ng-template ngSwitchDefault>
                                <select-box (newClick)="goToRefPage('subject','biotype')" formControlName="biotype" [optionArr]="biotypes">
                                </select-box>
                                <label *ngIf="hasError('animalSubject.biotype', ['required'])" [@slideDown]="hasError('animalSubject.biotype', ['required'])" class="form-validation-alert" i18n="Edit subjectBiotype|Biotype required error@@animalSubjectDetailBiotypeRequiredError">Biological type is required!</label>
                            </ng-template>
                        </span>
                    </li>
                    <li>
                        <label i18n="Edit subject|Provider label">Provider</label>
                        <span class="right-col" [ngSwitch]="mode">
                            <ng-template [ngSwitchCase]="'view'">
                                    {{animalSubject?.provider?.value}}
                            </ng-template>
                            <ng-template ngSwitchDefault>
                                <select-box (newClick)="goToRefPage('subject','provider')" formControlName="provider" [optionArr]="providers">
                                </select-box>
                                <label *ngIf="hasError('animalSubject.provider', ['required'])" [@slideDown]="hasError('animalSubject.provider', ['required'])" class="form-validation-alert" i18n="Edit subjectProvider|Provider required error@@animalSubjectDetailProviderRequiredError">Provider is required!</label>
                            </ng-template>
                        </span>
                    </li>
                    <li>
                        <label i18n="Edit subject|Stabulation label">Stabulation</label>
                        <span class="right-col" [ngSwitch]="mode">
                            <ng-template [ngSwitchCase]="'view'">
                                    {{animalSubject?.stabulation?.value}}
                            </ng-template>
                            <ng-template ngSwitchDefault>
                                <select-box (newClick)="goToRefPage('subject','stabulation')" formControlName="stabulation" [optionArr]="stabulations">
                                </select-box>
                                <label *ngIf="hasError('animalSubject.stabulation', ['required'])" [@slideDown]="hasError('animalSubject.stabulation', ['required'])" class="form-validation-alert" i18n="Edit subjectStabulation|Stabulation required error@@animalSubjectDetailStabulationRequiredError">Stabulation is required!</label>
                            </ng-template>
                        </span>
                    </li>
                </ol>
            </fieldset>

			<!-- Study -->
			<fieldset formGroupName="subject">
                <legend>Study</legend>
                <ol>
					<li>
                        <label>Study</label>
                        <span class="right-col">
							{{animalSubject?.subject?.study?.name}}
                        </span>
                    </li>
				</ol>
				<ol *ngIf="animalSubject.subject.identifier != null">
					<li>
						<label>Subject identifier for this study</label>
						<span class="right-col">
							{{ animalSubject.subject.identifier }}
						</span>
					</li>
				</ol>
				<ol>
					<li>
						<label>Tags</label>
						<span class="right-col" [ngSwitch]="mode">
							<ng-template [ngSwitchCase]="'view'">
								<span class="tag" [class.dark]="getFontColor(tag.color)" [style.background]="tag.color"
									*ngFor="let tag of animalSubject.subject.tags">
									{{tag.name}}
								</span>
							</ng-template>
							<ng-template ngSwitchDefault>
								<tag-list
									[availableTags]="animalSubject.subject.study?.tags" formControlName="tags"></tag-list>
							</ng-template>
						</span>
					</li>
				</ol>
                <ol class="subject-study">
                    <div>
                        <li>
                            <label>Subject type</label>
                            <span class="right-col" [ngSwitch]="mode">
                                <ng-template [ngSwitchCase]="'view'">
                                    {{animalSubject.subject.subjectType}}
                                </ng-template>
                                <ng-template ngSwitchDefault>
                                    <select-box formControlName="subjectType"
                                                [options]="subjectTypes">
                                    </select-box>
                                </ng-template>
						    </span>
                        </li>
                        <li>
                            <label>Physically involved</label>
                            <span class="right-col" [ngSwitch]="mode">
								<ng-template [ngSwitchCase]="'view'">
									<span *ngIf="animalSubject.subject.physicallyInvolved" class="bool-true"><i class="fas fa-check"></i></span>
									<span *ngIf="!animalSubject.subject.physicallyInvolved" class="bool-false"><i class="fas fa-times"></i></span>
								</ng-template>
								<ng-template ngSwitchDefault>
									<checkbox formControlName="physicallyInvolved"></checkbox>
								</ng-template>
							</span>
                        </li>
                    </div>
                </ol>
			</fieldset>
            
            <!-- Pathologies and therapies sections -->
        </div>
		<div *ngIf="displayPathologyTherapy">
			<fieldset>
				<legend i18n="AnimalSubjectDetail|Pathologies label@@animalSubjectDetailPathologies">Pathologies</legend>
                <subject-pathology-list [mode]="mode" formControlName="subjectPathologies" (openCreationForm)="openCreateSubjectPathology()"></subject-pathology-list>
			</fieldset>

			<fieldset>
				<legend i18n="AnimalSubjectDetail|Therapies label@@animalSubjectDetailTherapies">Therapies</legend>
                <subject-therapy-list [mode]="mode" formControlName="subjectTherapies" (openCreationForm)="openCreateSubjectTherapy()"></subject-therapy-list>
			</fieldset>
		</div>
    </form>
</div>
