<!--
Shanoir NG - Import, manage and share neuroimaging data
Copyright (C) 2009-2019 Inria - https://www.inria.fr/
Contact us on https://project.inria.fr/shanoir/

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

You should have received a copy of the GNU General Public License
along with this program. If not, see https://www.gnu.org/licenses/gpl-3.0.html
-->

<div class="content-component detail" [@preventInitialChildAnimations]>
	<form *ngIf="form" [formGroup]="form" class="max-content" novalidate>
		<div class="layout" [ngClass]="{'left': mode=='view'}">
			<span class="right-col" [ngSwitch]="mode">
				<ng-template [ngSwitchCase]="'view'">
					<div class="header command-zone" i18n="View subject|Title">View subject</div>
				</ng-template>
				<ng-template [ngSwitchCase]="Modes.edit"> 
					<div class="header command-zone" i18n="Edit subject|Title">Edit subject</div>
				</ng-template>
				<ng-template [ngSwitchCase]="Modes.create"> 
					<div class="header command-zone" i18n="Create subject|Title">Create subject</div>
				</ng-template>
			</span>

			<fieldset>
				<legend *ngIf="mode !== 'view'" i18n="Subject detail|Name label@@subjectDetailGeneral">General</legend>
				<ol>
					<li>
						<label i18n="Subject detail|Subject Imaged object category label@@SubjectDetailSubjectImagedObjectCategory" class="required-label">Imaged object category</label>
						<span class="right-col" [ngSwitch]="mode">
							<ng-template [ngSwitchCase]="'view'">
								{{preclinicalSubject.subject.imagedObjectCategory}}
							</ng-template>
							<ng-template ngSwitchDefault>
								<select-box formControlName="imagedObjectCategory" [(ngModel)]="preclinicalSubject.subject.imagedObjectCategory" (change)="buildForm()">
									<select-option *ngFor="let cat of ImagedObjectCategory.allPreClinical(true)" [value]="cat" [ngSwitch]="cat"
										i18n="Imaged Object Category {{cat}}|Category label@@ImagedObjectCategory{{cat}}">
											<ng-template [ngSwitchCase]="ImagedObjectCategory.PHANTOM">Phantom</ng-template>
											<ng-template [ngSwitchCase]="ImagedObjectCategory.LIVING_HUMAN_BEING">Living human being</ng-template>
											<ng-template [ngSwitchCase]="ImagedObjectCategory.HUMAN_CADAVER">Human cadaver</ng-template>
											<ng-template [ngSwitchCase]="ImagedObjectCategory.ANATOMICAL_PIECE">Anatomical piece</ng-template>
											<ng-template [ngSwitchCase]="ImagedObjectCategory.LIVING_ANIMAL">Living animal</ng-template>
											<ng-template [ngSwitchCase]="ImagedObjectCategory.ANIMAL_CADAVER">Animal cadaver</ng-template>
											<ng-template ngSwitchDefault>{{cat}}</ng-template>
									</select-option>
								</select-box>
								<label *ngIf="hasError('imagedObjectCategory', ['required'])" class="form-validation-alert" i18n="Subject detail|ImagedObjectCategory required error@@subjectDetailImagedObjectCategoryRequiredError">Imaged object category is required!</label>
							</ng-template>
						</span>
					</li>
					<li>
						<label i18n="Edit subject|Name label" class="required-label">Common name</label>
						<span class="right-col" [ngSwitch]="mode">
							<ng-template [ngSwitchCase]="'view'"> 
									{{preclinicalSubject?.subject?.name}}
							</ng-template>
							<ng-template ngSwitchDefault>
									<input type="text" id="name" required minlength="2" maxlength="200" formControlName="name" [(ngModel)]="preclinicalSubject.subject.name"/>
									<label *ngIf="hasError('name', ['required'])" class="form-validation-alert" i18n="Subject detail|Name required error@@subjectDetailNameRequiredError">Common Name is required !</label>
									<label *ngIf="hasError('name', ['minlength', 'maxlength'])" class="form-validation-alert" i18n="Subject detail|Name Length error@@subjectDetailNameLengthError">Length must be between 2 and 64 !</label>
									<label *ngIf="hasError('name', ['unique'])" class="form-validation-alert" i18n="Subject detail|Name unique error@@subjectDetailNameUniqueError">This name is already taken !</label>
									<label *ngIf="existingSubjectError" class="form-validation-alert" i18n="Subject detail|Existing subject error@@existingSubjectError">
										This subject already exists and his common name is {{existingSubjectError}}
									</label>
								</ng-template>	
						</span>
					</li>
					<li *ngIf="displaySex()">
						<label i18n="Subject detail|Sex label@@subjectDetailSex" class="required-label">Sex</label>
						<span class="right-col" [ngSwitch]="mode">
							<ng-template [ngSwitchCase]="'view'"> 
								<div [ngSwitch]="preclinicalSubject.subject.sex">
									<ng-template [ngSwitchCase]="'F'">Female</ng-template>
									<ng-template [ngSwitchCase]="'M'">Male</ng-template>
									<ng-template ngSwitchDefault>{{preclinicalSubject?.subject?.sex}}</ng-template>
								</div>
							</ng-template>
							<ng-template ngSwitchDefault>
								<select id="sex" required formControlName="sex" [(ngModel)]="preclinicalSubject.subject.sex">
									<option [value]="'F'">Female</option>
									<option [value]="'M'">Male</option>
								</select>
							</ng-template>
						</span>
					</li>
					<li>
						<label i18n="Edit subject|Specie label" class="required-label">Species</label>
						<span class="right-col" [ngSwitch]="mode">
							<ng-template [ngSwitchCase]="'view'"> 
									{{preclinicalSubject?.animalSubject?.specie?.value}}
							</ng-template>
							<ng-template ngSwitchDefault>
								<select-box (onNewClick)="goToRefPage('subject','specie')" formControlName="specie" [(ngModel)]="preclinicalSubject.animalSubject.specie">
									<select-option *ngFor="let specie of species" [value]="specie">{{specie.value}}</select-option>
								</select-box>
								<label *ngIf="hasError('specie', ['required'])" [@slideDown]="hasError('specie', ['required'])" class="form-validation-alert" i18n="Edit subjectSpecie|Specie required error@@animalSubjectDetailSpecieRequiredError">Species is required!</label>
							</ng-template>
						</span>
					</li>
					<li >
						<label i18n="Edit subject|Strain label" class="required-label">Strain</label>
						<span class="right-col" [ngSwitch]="mode">
							<ng-template [ngSwitchCase]="'view'"> 
									{{preclinicalSubject?.animalSubject?.strain?.value}}
							</ng-template>
							<ng-template ngSwitchDefault>
								<select-box (onNewClick)="goToRefPage('subject','strain')" formControlName="strain" [(ngModel)]="preclinicalSubject.animalSubject.strain">
									<select-option *ngFor="let strain of strains" [value]="strain">{{strain.value}}</select-option>
								</select-box>
								<label *ngIf="hasError('strain', ['required'])" [@slideDown]="hasError('strain', ['required'])" class="form-validation-alert" i18n="Edit subjectStrain|Strain required error@@animalSubjectDetailStrainRequiredError">Strain is required!</label>
							</ng-template>
						</span>
					</li>
					<li >
						<label i18n="Edit subject|Biotype label" class="required-label">Biological type</label> 
						<span class="right-col" [ngSwitch]="mode">
							<ng-template [ngSwitchCase]="'view'"> 
									{{preclinicalSubject?.animalSubject?.biotype?.value}}
							</ng-template>
							<ng-template ngSwitchDefault>
								<select-box (onNewClick)="goToRefPage('subject','biotype')" formControlName="biotype" [(ngModel)]="preclinicalSubject.animalSubject.biotype">
									<select-option *ngFor="let biotype of biotypes" [value]="biotype">{{biotype.value}}</select-option>
								</select-box>
								<label *ngIf="hasError('biotype', ['required'])" [@slideDown]="hasError('biotype', ['required'])" class="form-validation-alert" i18n="Edit subjectBiotype|Biotype required error@@animalSubjectDetailBiotypeRequiredError">Biological type is required!</label>
							</ng-template>
						</span>							
					</li>
					<li >
						<label i18n="Edit subject|Provider label" class="required-label">Provider</label>
						<span class="right-col" [ngSwitch]="mode">
							<ng-template [ngSwitchCase]="'view'"> 
									{{preclinicalSubject?.animalSubject?.provider?.value}}
							</ng-template>
							<ng-template ngSwitchDefault>
								<select-box (onNewClick)="goToRefPage('subject','provider')" formControlName="provider" [(ngModel)]="preclinicalSubject.animalSubject.provider">
									<select-option *ngFor="let provider of providers" [value]="provider">{{provider.value}}</select-option>
								</select-box>
								<label *ngIf="hasError('provider', ['required'])" [@slideDown]="hasError('provider', ['required'])" class="form-validation-alert" i18n="Edit subjectProvider|Provider required error@@animalSubjectDetailProviderRequiredError">Provider is required!</label>
							</ng-template>
						</span>
					</li>
					<li>
						<label i18n="Edit subject|Stabulation label" class="required-label">Stabulation</label> 
						<span class="right-col" [ngSwitch]="mode">
							<ng-template [ngSwitchCase]="'view'"> 
									{{preclinicalSubject?.animalSubject?.stabulation?.value}}
							</ng-template>
							<ng-template ngSwitchDefault>
								<select-box (onNewClick)="goToRefPage('subject','stabulation')" formControlName="stabulation" [(ngModel)]="preclinicalSubject.animalSubject.stabulation">
									<select-option *ngFor="let stabulation of stabulations" [value]="stabulation">{{stabulation.value}}</select-option>
								</select-box>
								<label *ngIf="hasError('stabulation', ['required'])" [@slideDown]="hasError('stabulation', ['required'])" class="form-validation-alert" i18n="Edit subjectStabulation|Stabulation required error@@animalSubjectDetailStabulationRequiredError">Stabulation is required!</label>
							</ng-template>
						</span>
					</li>
				</ol>
			</fieldset>
			
			<fieldset *ngIf="mode !== 'view'">
					<subject-study-list [subject]="preclinicalSubject.subject" [displaySubjectType]="false" [selectableList]="studies" [(ngModel)]="preclinicalSubject.subject.subjectStudyList" formControlName="subjectStudyList"></subject-study-list>
			</fieldset>
			<fieldset *ngIf="mode == 'view'">
					<legend i18n="Subject data|Title@@subjectDetailDataTitle">Data</legend>
					<subject-tree [subject]="preclinicalSubject.subject" [studies]="studies"></subject-tree>
			</fieldset>	
			<div *ngIf="displayPathologyTherapy">
				<fieldset>
					<legend i18n="AniamlSubjectDetail|Pathologies label@@animalSubjectDetailPathologies">Pathologies</legend>
				</fieldset>		
				<div [ngSwitch]="mode">
						<ng-template [ngSwitchCase]="'edit'">
							<button *ngIf="keycloakService.isUserAdmin() || keycloakService.isUserExpert()" i18n="Edit model|Add a new pathology" (click)="goToAddPathology()">
								<i class="fas fa-plus-square"></i>
								new pathology
							</button>
						</ng-template>
						<ng-template [ngSwitchCase]="'create'" *ngIf="keycloakService.isUserAdmin() || keycloakService.isUserExpert()">
							<button *ngIf="keycloakService.isUserAdmin() || keycloakService.isUserExpert()" i18n="Edit model|Add a new pathology" (click)="goToAddPathology()">
								<i class="fas fa-plus-square"></i>
								new pathology
							</button>
						</ng-template>
					</div>
				<div>
					<subject-pathology-form [preclinicalSubject]="preclinicalSubject"  [createSPMode]="createSPMode"
								[toggleForm]="toggleFormSP" [subjectpathoSelected]="pathoSelected"  (onEvent)="refreshDisplayPathology($event[0], $event[1])">
					</subject-pathology-form>
				</div>
				<shanoir-table #subjectPathologiesTable
    				[getPage]="getPagePathology.bind(this)" 
    				[columnDefs]="columnDefsPathologies" >
				</shanoir-table> 
				<fieldset>
					<legend i18n="AniamlSubjectDetail|Therapies label@@animalSubjectDetailTherapies">Therapies</legend>
				</fieldset>
				<div [ngSwitch]="mode">
						<ng-template [ngSwitchCase]="'edit'">
							<button *ngIf="keycloakService.isUserAdmin() || keycloakService.isUserExpert()" i18n="Edit model|Add a new therapy" (click)="goToAddTherapy()">
								<i class="fas fa-plus-square"></i>
								new therapy
							</button>
						</ng-template>
						<ng-template [ngSwitchCase]="'create'" *ngIf="keycloakService.isUserAdmin() || keycloakService.isUserExpert()">
							<button *ngIf="keycloakService.isUserAdmin() || keycloakService.isUserExpert()" i18n="Edit model|Add a new therapy" (click)="goToAddTherapy()">
								<i class="fas fa-plus-square"></i>
								new therapy
							</button>
						</ng-template>
					</div>
				<div>
					<subject-therapy-form [preclinicalSubject]="preclinicalSubject"  [createSTMode]="createSTMode"
								[toggleForm]="toggleFormST" [subTherapySelected]="therapySelected"  (onEvent)="refreshDisplayTherapy($event[0], $event[1])">
					</subject-therapy-form>
				</div>
				<shanoir-table #subjectTherapiesTable
    				[getPage]="getPageTherapy.bind(this)" 
    				[columnDefs]="columnDefsTherapies" >
				</shanoir-table> 
			</div>
			<form-footer
				[state]="footerState"
				(save)="save()"
				(edit)="goToEdit()"
				(cancel)="goToView(this.entity.animalSubject.id)"
				(back)="goBack()">
			</form-footer>
		</div>
    </form>
</div>