<!--
Shanoir NG - Import, manage and share neuroimaging data
Copyright (C) 2009-2019 Inria - https://www.inria.fr/
Contact us on https://project.inria.fr/shanoir/

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

You should have received a copy of the GNU General Public License
along with this program. If not, see https://www.gnu.org/licenses/gpl-3.0.html
-->

<div #formContainer class="content-component detail" [@preventInitialChildAnimations]>
    @if (form) {
        <form [formGroup]="form" class="max-content" novalidate [class.disabled]="footerState.loading">
            <div class="layout" [ngClass]="{ left: mode == 'view' }">
                <form-footer
                    [state]="footerState"
                    (save)="subject.subjectStudyList?.length >= 1 || mode == 'create' ? save() : delete()"
                    (delete)="delete()"
                    (edit)="goToEdit()"
                    (dismiss)="goToView()"
                    (back)="goBack()">
                    @if (mode == "view" && hasDownloadRight) {
                        <button
                            class="right-icon dl-button"
                            type="button"
                            (click)="download()"
                            [disabled]="downloadState.isActive()">
                            Download
                            <i class="fas fa-download"></i>
                        </button>
                    }
                </form-footer>
                <span>
                    @switch (mode) {
                        @case ("view") {
                            <h2 class="header command-zone" i18n="View subject|Title@@subjectDetailViewTitle">
                                Details on subject
                            </h2>
                        }
                        @case ("edit") {
                            <h2 class="header command-zone" i18n="Edit subject|Title@@subjectDetailEditTitle">
                                Edit subject
                            </h2>
                        }
                        @case ("create") {
                            <h2 class="header command-zone" i18n="Create subject|Title@@subjectDetailCreateTitle">
                                Create subject
                            </h2>
                        }
                    }
                </span>
                <fieldset>
                    @if (mode !== "view") {
                        <legend i18n="Subject detail|Name label@@subjectDetailGeneral">General</legend>
                    }
                    <ol>
                        <li>
                            <label
                                i18n="
                                    Subject detail|Subject Imaged object category
                                    label@@SubjectDetailSubjectImagedObjectCategory">
                                Imaged object category
                            </label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("view") {
                                        {{ subject.imagedObjectCategory }}
                                    }
                                    @default {
                                        <select-box
                                            formControlName="imagedObjectCategory"
                                            [options]="catOptions"></select-box>
                                        @if (hasError("imagedObjectCategory", ["required"])) {
                                            <label
                                                class="form-validation-alert"
                                                i18n="
                                                    Subject detail|ImagedObjectCategory required
                                                    error@@subjectDetailImagedObjectCategoryRequiredError">
                                                Imaged object category is required!
                                            </label>
                                        }
                                    }
                                }
                            </span>
                        </li>
                    </ol>
                    <ol>
                        @if (humanSelected()) {
                            <div [@slideDown]="humanSelected()">
                                @if (mode == "create" && humanSelected() && importMode != "EEG") {
                                    <li>
                                        <label
                                            i18n="
                                                Subject detail|Subject is already anonymized
                                                label@@SubjectDetailSubjectIsAlreadyAnonymized">
                                            Is the subject already anonymized?
                                        </label>
                                        <span class="right-col">
                                            <input
                                                type="radio"
                                                formControlName="isAlreadyAnonymized"
                                                [value]="true"
                                                [checked]="subject.isAlreadyAnonymized == true" />
                                            Yes
                                            <input
                                                type="radio"
                                                formControlName="isAlreadyAnonymized"
                                                [value]="false"
                                                [checked]="subject.isAlreadyAnonymized == false" />
                                            No
                                        </span>
                                    </li>
                                }
                                @if (!subject.isAlreadyAnonymized && mode == "create") {
                                    <li class="info" [@slideDown]="!subject.isAlreadyAnonymized && mode == 'create'">
                                        <span class="icon"><i class="fas fa-info-circle"></i></span>
                                        A subject global identifier will be automatically generated using the first
                                        name, the last name and the birth date of the subject. This can help you to
                                        identify a subject that has already been inserted into the database.
                                        <br />
                                        To ensure anonymity, the first name and the last name will not be saved.
                                        <br />
                                        Note that the birth date will be set to January 1st of the birth year for the
                                        same reason.
                                    </li>
                                }
                                @if (!subject.isAlreadyAnonymized && mode == "create" && importMode != "EEG") {
                                    <li>
                                        <label
                                            i18n="Subject detail|First Name label@@SubjectDetailSubjectFirstName"
                                            [class.required-label]="
                                                subject.imagedObjectCategory == 'LIVING_HUMAN_BEING'
                                            ">
                                            First name
                                        </label>
                                        <span class="right-col">
                                            @if (importMode != "DICOM") {
                                                <input type="text" id="firstName" formControlName="firstName" />
                                            }
                                            @if (importMode == "DICOM") {
                                                <div>{{ firstName }}</div>
                                            }
                                            @if (hasError("firstName", ["required"])) {
                                                <label
                                                    class="form-validation-alert"
                                                    i18n="
                                                        Subject detail|FirstName required
                                                        error@@subjectDetailFirstNameRequiredError">
                                                    First name is required!
                                                </label>
                                            }
                                            @if (hasError("firstName", ["minlength", "maxlength"])) {
                                                <label
                                                    class="form-validation-alert"
                                                    i18n="
                                                        Subject detail|Name Length error@@subjectDetailNameLengthError">
                                                    Length must be between 2 and 64!
                                                </label>
                                            }
                                        </span>
                                    </li>
                                }
                                @if (!subject.isAlreadyAnonymized && mode == "create" && importMode != "EEG") {
                                    <li>
                                        <label
                                            i18n="Subject detail|Last Name label@@SubjectDetailSubjectLastName"
                                            [class.required-label]="
                                                subject.imagedObjectCategory == 'LIVING_HUMAN_BEING'
                                            ">
                                            Last name
                                        </label>
                                        <span class="right-col">
                                            @if (importMode != "DICOM") {
                                                <input type="text" id="lastName" formControlName="lastName" />
                                            }
                                            @if (importMode == "DICOM") {
                                                <div>{{ lastName }}</div>
                                            }
                                            @if (hasError("lastName", ["required"])) {
                                                <label
                                                    class="form-validation-alert"
                                                    i18n="
                                                        Subject detail|LastName required
                                                        error@@subjectDetailLastNameRequiredError">
                                                    Last name is required!
                                                </label>
                                            }
                                            @if (hasError("lastName", ["minlength", "maxlength"])) {
                                                <label
                                                    class="form-validation-alert"
                                                    i18n="
                                                        Subject detail|Name Length error@@subjectDetailNameLengthError">
                                                    Length must be between 2 and 64!
                                                </label>
                                            }
                                        </span>
                                    </li>
                                }
                            </div>
                        }
                        <li>
                            <label i18n="Subject detail|Name label@@subjectDetailName">Common name</label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("view") {
                                        {{ subject.name }}
                                    }
                                    @case ("edit") {
                                        {{ subject.name }}
                                    }
                                    @default {
                                        <input type="text" id="name" formControlName="name" />
                                        @if (hasError("name", ["required"])) {
                                            <label
                                                class="form-validation-alert"
                                                i18n="
                                                    Subject detail|Name required error@@subjectDetailNameRequiredError">
                                                Common Name is required !
                                            </label>
                                        }
                                        @if (hasError("name", ["minlength", "maxlength"])) {
                                            <label
                                                class="form-validation-alert"
                                                i18n="Subject detail|Name Length error@@subjectDetailNameLengthError">
                                                Length must be between 2 and 64 !
                                            </label>
                                        }
                                        @if (hasError("name", ["unique"])) {
                                            <label
                                                class="form-validation-alert"
                                                i18n="Subject detail|Name unique error@@subjectDetailNameUniqueError">
                                                This name is already taken !
                                            </label>
                                        }
                                        @if (hasError("name", ["subjectNamePrefix"])) {
                                            <label
                                                class="form-validation-alert"
                                                i18n="Subject detail|Name unique error@@subjectDetailNameUniqueError">
                                                The name should not be equal to the study prefix.
                                            </label>
                                        }
                                        @if (hasError("name", ["pattern"])) {
                                            <label
                                                class="form-validation-alert"
                                                i18n="Subject detail|Name chars error@@subjectDetailNameCharsError">
                                                Forbidden characters
                                            </label>
                                        }
                                        @if (hasError("name", ["notEmptyValidator"])) {
                                            <label
                                                class="form-validation-alert"
                                                i18n="Subject detail|Name empty error@@subjectDetailNameCharsError">
                                                Name must contain more than one character
                                            </label>
                                        }
                                    }
                                }
                            </span>
                        </li>
                        @if (subjectNamePrefix && !subject.name?.startsWith(subjectNamePrefix) && mode != "view") {
                            <li class="info" @slideDown>
                                <span class="icon"><i class="fas fa-info-circle"></i></span>
                                This study is configured to use prefixes for subject names, here the prefix is
                                <b>{{ subjectNamePrefix }}</b>
                                . However the prefix is optional and if you know what you are doing please just ignore
                                this message.
                            </li>
                        }
                        @if (humanSelected()) {
                            <div [@slideDown]="humanSelected()">
                                @if (mode == "create" || mode == "view") {
                                    <li>
                                        <label
                                            i18n="Subject detail|Birth date label@@subjectDetailBirthDate"
                                            [class.required-label]="
                                                subject.imagedObjectCategory == 'LIVING_HUMAN_BEING'
                                            ">
                                            Birth date
                                        </label>
                                        <span class="right-col">
                                            @switch (mode) {
                                                @case ("view") {
                                                    {{ subject.birthDate | localDateFormatPipe }}
                                                }
                                                @case ("create") {
                                                    <datepicker formControlName="birthDate"></datepicker>
                                                    @if (hasError("birthDate", ["format"])) {
                                                        <label
                                                            class="form-validation-alert"
                                                            i18n="Subject detail|Date valid error@@dateValidError">
                                                            Date should be valid! Date format: {{ dateDisplay }}
                                                        </label>
                                                    }
                                                    @if (hasError("birthDate", ["required"])) {
                                                        <label
                                                            class="form-validation-alert"
                                                            i18n="
                                                                Subject detail|BirthDate required
                                                                error@@subjectDetailBirthDateRequiredError">
                                                            You need to enter a birth date for a living humain being!
                                                        </label>
                                                    }
                                                }
                                            }
                                        </span>
                                    </li>
                                }
                                <li>
                                    <label i18n="Subject detail|Sex label@@subjectDetailSex">Sex</label>
                                    <span class="right-col">
                                        @switch (mode) {
                                            @case ("view") {
                                                {{ subject.sex }}
                                            }
                                            @case ("edit") {
                                                {{ subject.sex }}
                                            }
                                            @default {
                                                <select-box
                                                    formControlName="sex"
                                                    [options]="genderOptions"></select-box>
                                            }
                                        }
                                    </span>
                                </li>
                                <li>
                                    <label
                                        i18n="
                                            Subject detail|Manual Hemispheric Dominance
                                            label@@subjectDetailManualHemisphericDominance">
                                        Manual hemispheric dominance
                                    </label>
                                    <span class="right-col">
                                        @switch (mode) {
                                            @case ("view") {
                                                {{ subject.manualHemisphericDominance }}
                                            }
                                            @default {
                                                <select-box
                                                    formControlName="manualHemisphericDominance"
                                                    [optionArr]="['Left', 'Right']"></select-box>
                                            }
                                        }
                                    </span>
                                </li>
                                <li>
                                    <label
                                        i18n="
                                            Subject detail|Language Hemispheric Dominance
                                            label@@subjectDetailLanguageHemisphericDominance">
                                        Language hemispheric dominance
                                    </label>
                                    <span class="right-col">
                                        @switch (mode) {
                                            @case ("view") {
                                                {{ subject.languageHemisphericDominance }}
                                            }
                                            @default {
                                                <select-box
                                                    formControlName="languageHemisphericDominance"
                                                    [optionArr]="['Left', 'Right']"></select-box>
                                            }
                                        }
                                    </span>
                                </li>
                            </div>
                        }
                    </ol>
                    @if (!humanSelected()) {
                        <ol [@slideDown]="!humanSelected()">
                            @if (mode == "create") {
                                <li>
                                    <label
                                        class="date-label"
                                        i18n="Subject detail|Birth date label@@subjectDetailBirthDate">
                                        Date of creation
                                    </label>
                                    <span class="right-col">
                                        <datepicker formControlName="birthDate"></datepicker>
                                        @if (hasError("birthDate", ["format"])) {
                                            <label
                                                class="form-validation-alert"
                                                i18n="Subject detail|Date valid error@@dateValidError">
                                                Date should be valid! Date format: {{ dateDisplay }}
                                            </label>
                                        }
                                    </span>
                                </li>
                            }
                        </ol>
                    }
                    <ol class="subject-study">
                        <div>
                            <li>
                                <label>Subject type</label>
                                <span class="right-col">
                                    @switch (mode) {
                                        @case ("view") {
                                            {{ subject.subjectType }}
                                        }
                                        @default {
                                            <select-box
                                                formControlName="subjectType"
                                                [options]="subjectTypes"></select-box>
                                        }
                                    }
                                </span>
                            </li>
                            <li>
                                <label>Physically involved</label>
                                <span class="right-col">
                                    @switch (mode) {
                                        @case ("view") {
                                            @if (subject.physicallyInvolved) {
                                                <span class="bool-true"><i class="fas fa-check"></i></span>
                                            }
                                            @if (!subject.physicallyInvolved) {
                                                <span class="bool-false"><i class="fas fa-times"></i></span>
                                            }
                                        }
                                        @default {
                                            <checkbox formControlName="physicallyInvolved"></checkbox>
                                        }
                                    }
                                </span>
                            </li>
                        </div>
                    </ol>
                </fieldset>
                @if (!forceStudy) {
                    <fieldset>
                        <legend i18n="Subject detail|Name label@@subjectDetailGeneral">Study</legend>
                        <ol>
                            <li>
                                <label i18n="Subject detail |Study label@@SubjectDetailSubjectStudy">Study</label>
                                <span class="right-col">
                                    @switch (mode) {
                                        @case ("create") {
                                            <select-box
                                                formControlName="study"
                                                [optionArr]="studies"
                                                (userChange)="onSelectStudy()"></select-box>
                                        }
                                        @default {
                                            {{ studyNameForSubject() }}
                                            @if (hasError("study", ["required"])) {
                                                <label
                                                    class="form-validation-alert"
                                                    i18n="
                                                        Subject detail|Study required
                                                        error@@subjectDetailStudyRequiredError">
                                                    Study is required!
                                                </label>
                                            }
                                        }
                                    }
                                </span>
                            </li>
                        </ol>
                        @if (hasError("subjectStudyList", ["required"])) {
                            <label
                                class="form-validation-alert"
                                i18n="
                                    Subject detail|Subject StudyList required
                                    error@@subjectDetailSubjectStudyListRequiredError">
                                Study is required!
                            </label>
                        }
                    </fieldset>
                }
                @if (forceStudy) {
                    <fieldset>
                        <legend i18n="Subject detail|Name label@@subjectDetailGeneral">Study</legend>
                        <ol>
                            <li>
                                <label>Study</label>
                                <span class="right-col">{{ forceStudy.name }}</span>
                            </li>
                        </ol>
                    </fieldset>
                }
                <fieldset>
                    @if (subject.identifier != null) {
                        <ol>
                            <li>
                                <label>Subject identifier for this study</label>
                                <span class="right-col">
                                    {{ subject.identifier }}
                                </span>
                            </li>
                        </ol>
                    }
                    <ol>
                        <li>
                            <label>Tags</label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("view") {
                                        @for (tag of subject.tags; track tag) {
                                            <span
                                                class="tag"
                                                [class.dark]="getFontColor(tag.color)"
                                                [style.background]="tag.color">
                                                {{ tag.name }}
                                            </span>
                                        }
                                    }
                                    @default {
                                        <tag-list
                                            [availableTags]="subject.study?.tags"
                                            formControlName="tags"></tag-list>
                                    }
                                }
                            </span>
                        </li>
                    </ol>
                </fieldset>
            </div>
        </form>
    }
</div>
