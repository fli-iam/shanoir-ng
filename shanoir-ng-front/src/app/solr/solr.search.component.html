<!--
Shanoir NG - Import, manage and share neuroimaging data
Copyright (C) 2009-2019 Inria - https://www.inria.fr/
Contact us on https://project.inria.fr/shanoir/

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

You should have received a copy of the GNU General Public License
along with this program. If not, see https://www.gnu.org/licenses/gpl-3.0.html
-->

<form class="row" [formGroup]="form">
    
    <div class="left">
        <h2>Solr Search</h2>

        <div class="reset">
            <button type="button" (click)="removeAllFacets(); keyword = null; table.refresh()" class="left-icon" [disabled]="(!selections || selections.length == 0) && (!keyword || keyword.trim().length == 0)">
                <i class="fas fa-snowplow"></i>Reset
            </button>
        </div>

        <solr-criterion
                label="Study"
                [currentFacetPage]="facetResultPages[0]"
                [allFacetPage]="allFacetResultPages[0]"
                (onChange)="updateSelections(); table.refresh()">
        </solr-criterion>

        <solr-criterion
                label="Subject"
                [currentFacetPage]="facetResultPages[1]"
                [allFacetPage]="allFacetResultPages[1]"
                (onChange)="updateSelections(); table.refresh()">
        </solr-criterion>

        <solr-criterion
                label="Dataset"
                [currentFacetPage]="facetResultPages[2]"
                [allFacetPage]="allFacetResultPages[2]"
                (onChange)="updateSelections(); table.refresh()">
        </solr-criterion>

        <div class="dates">
            <div class="title">Dataset Creation Date</div>
            <div class="date-from">
                <span class="left-title">from :</span> <datepicker [(ngModel)]="datasetStartDate" (ngModelChange)="onDateChange($event)" formControlName="startDate"></datepicker>
                <label *ngIf="hasError('startDate', ['format'])" class="form-validation-alert">Date should be valid! Date format: dd/mm/yyyy</label>
            </div>
            <div class="date-to">
                <span class="left-title">to :</span> <datepicker [(ngModel)]="datasetEndDate" (ngModelChange)="onDateChange($event)" formControlName="endDate"></datepicker>
                <label *ngIf="hasError('endDate', ['format'])" class="form-validation-alert">Date should be valid! Date format: dd/mm/yyyy</label>
                <label *ngIf="hasError('endDate', ['order'])" class="form-validation-alert">End date must be subsequent to start date</label>
            </div>
        </div>

        <solr-criterion
                label="Examination"
                [currentFacetPage]="facetResultPages[3]"
                [allFacetPage]="allFacetResultPages[3]"
                (onChange)="updateSelections(); table.refresh()">
        </solr-criterion>

        <solr-criterion
                label="Dataset Modality Type"
                [currentFacetPage]="facetResultPages[4]"
                [allFacetPage]="allFacetResultPages[4]"
                (onChange)="updateSelections(); table.refresh()">
        </solr-criterion>

        <solr-criterion
                label="Mr Dataset Nature"
                [currentFacetPage]="facetResultPages[5]"
                [allFacetPage]="allFacetResultPages[5]"
                (onChange)="updateSelections(); table.refresh()">
        </solr-criterion>

    </div>
    <div class="right">

        <solr-text-search 
                (onChange)="onSearchTextChange($event)" 
                (onType)="syntaxError = false" 
                [registerResetCallback]="registerTextResetCallback.bind(this)"
                [syntaxError]="syntaxError">
        </solr-text-search>

        <div *ngIf="selections" class="selections">
            <span class="selection" *ngFor="let sel of selections; let i = index">
                <span class="clickable" (click)="removeSelection(i); table.refresh();">
                    <i class="fas fa-times"></i>
                </span>
                {{sel.label}}
            </span>
        </div>

        <div [hidden]="progressBar.progress == 0">
            <progress-bar #progressBar [text]="'Preparing download'"></progress-bar>
        </div>
        <shanoir-table #table
            [getPage]="getPage.bind(this)" 
            [maxResults]="50"
            [columnDefs]="columnDefs" 
            [customActionDefs]="customActionDefs"
            (rowClick)="onRowClick($event)"
            [browserSearch]="false"
            [selectionAllowed]="true"
            (selectionChange)="onSelectionChange($event)">
        </shanoir-table>
    </div>
</form>