<!--
Shanoir NG - Import, manage and share neuroimaging data
Copyright (C) 2009-2019 Inria - https://www.inria.fr/
Contact us on https://project.inria.fr/shanoir/

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

You should have received a copy of the GNU General Public License
along with this program. If not, see https://www.gnu.org/licenses/gpl-3.0.html
-->

<div class="header command-zone">1. Select DICOM archive</div>
<fieldset class="step dicom">
    <checkbox [(ngModel)]="multipleExamImport" [disabled]="archiveStatus != 'none'"></checkbox>
    <label>Multi-examination import</label>
    @if (!multipleExamImport) {
        <div>
            <p>Please select a DICOM zip archive to import.</p>
            <p>This archive may contain a DICOMDIR file at its root :</p>
            <ul>
                <li>If a DICOMDIR is present, it will be used to import the data (RECOMMENDED).</li>
                <li>
                    If not, one will be automatically generated from DICOM images
                    <strong>at the root of the archive.</strong>
                </li>
            </ul>
        </div>
    }
    @if (multipleExamImport) {
        <div>
            <p>
                Multi-examination allows a more simple and automatic import, with multiple possible examinations (DICOM
                studies).
            </p>
            <p>Select a subject folder with one or multiple examination sub-folders and zip it.</p>
            <p>The files should be organized like this:</p>
            <p>
                SUBJECT_NAME.zip
                <br />
                - [subject-name]
                <br />
                - - [examination-comment]
                <br />
                - - - [series]
                <br />
                - - - - [list of dicom]
                <br />
            </p>
            <u>1) Subject:</u>
            <br />
            The subject will be automatically created, based on the subject name, and information found in the DICOM.
            Please note that there should be only ONE subject.
            <p>
                <u>2) Examination:</u>
                <br />
                The examination will be automatically created based on the examination comment.
                <br />
                Examination date and other information will be gathered from information found in the DICOM.
            </p>
            <p>
                Please select a study in which the data will be imported, and a study card (if study card policy is set
                to "mandatory") or select a center and an equipment.
            </p>
            <ol>
                <li>
                    <label class="required-label">Select a research study</label>
                    <span class="right-col">
                        <select-box
                            [(ngModel)]="study"
                            (userChange)="onSelectStudy()"
                            [viewDisabled]="!study"
                            [options]="studyOptions"></select-box>
                    </span>
                </li>
                @if (useStudyCard) {
                    <li>
                        <label class="required-label">Default study card</label>
                        <span class="right-col">
                            <select-box
                                [(ngModel)]="studyCard"
                                (userChange)="onSelectStudyCard()"
                                [options]="studycardOptions"></select-box>
                        </span>
                    </li>
                }
                @if (!useStudyCard) {
                    <li>
                        @if (modality != "MR") {
                            <label [class.required-label]="!useStudyCard">Select an acquisition center</label>
                        }
                        <span class="right-col">
                            @if (!useStudyCard || center) {
                                <select-box
                                    [disabled]="!useStudyCard && (!study || !centerOptions)"
                                    [readOnly]="useStudyCard"
                                    [(ngModel)]="center"
                                    (userChange)="onSelectCenter()"
                                    [viewRoute]="'/center/details/' + center?.id"
                                    [viewDisabled]="!center"
                                    [options]="centerOptions"></select-box>
                            }
                        </span>
                    </li>
                }
                @if (!useStudyCard) {
                    <li>
                        @if (modality != "MR") {
                            <label [class.required-label]="!useStudyCard">Select a center equipment</label>
                        }
                        <span class="right-col">
                            @if (!useStudyCard || acquisitionEquipment) {
                                <select-box
                                    [disabled]="!useStudyCard && (!center || !acquisitionEquipmentOptions)"
                                    [readOnly]="useStudyCard"
                                    [(ngModel)]="acquisitionEquipment"
                                    [viewRoute]="'/acquisition-equipment/details/' + acquisitionEquipment?.id"
                                    [viewDisabled]="!acquisitionEquipment"
                                    [options]="acquisitionEquipmentOptions"
                                    [pipe]="acqEqPipe"></select-box>
                            }
                        </span>
                    </li>
                }
            </ol>
        </div>
    }
    <upload-file
        [disabled]="
            multipleExamImport &&
            ((!studyCard && useStudyCard) || (!useStudyCard && (!center || !acquisitionEquipment)))
        "
        (fileChange)="uploadArchive($event)"
        [loading]="archiveStatus == 'uploading'"
        [error]="archiveStatus == 'error'"></upload-file>
    <div [hidden]="!uploadState?.progress">
        <progress-bar [progress]="uploadState?.progress" [text]="'Preparing upload'"></progress-bar>
    </div>
    @if (extensionError == true) {
        <label
            animate.enter="slide-down-error" animate.leave="slide-up-error" 
            class="form-validation-alert" 
            i18n="Import|ExtensionError label">
            A DICOM zip archive is required!
        </label>
    }
    @if (dicomDirMissingError == true) {
        <label
            animate.enter="slide-down-error" animate.leave="slide-up-error" 
            class="form-validation-alert" 
            i18n="Import|DicomDirMissingError label">
            DICOMDIR is missing in .zip file!
        </label>
    }
    @if (fileTooBigError) {
        <label 
            animate.enter="slide-down-error" animate.leave="slide-up-error" 
            class="form-validation-alert" 
            i18n="Import|fileTooBigError label">
            The uploaded file is too big, it should be less then 5Gb.
        </label>
    }
    @if (otherErrorMessage) {
        <label 
            animate.enter="slide-down-error" animate.leave="slide-up-error" 
            class="form-validation-alert" 
            i18n="Import label">
            {{ otherErrorMessage }}
        </label>
    }

    @if (modality && !multipleExamImport) {
        <p class="modality">The modality of the dataset(s) that you are importing is {{ modality }}</p>
    }
    @if (multipleExamImport && archiveStatus == "uploaded") {
        <p class="modality">The import successfully started. Please check "Jobs" tab to follow its progress.</p>
    }
</fieldset>
@if (!multipleExamImport) {
    <button class="next" [disabled]="!valid" (click)="next()">Next</button>
}
