<!--
Shanoir NG - Import, manage and share neuroimaging data
Copyright (C) 2009-2019 Inria - https://www.inria.fr/
Contact us on https://project.inria.fr/shanoir/

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

You should have received a copy of the GNU General Public License
along with this program. If not, see https://www.gnu.org/licenses/gpl-3.0.html
-->

<div #formContainer class="content-component">
    @if (form) {
        <form
            [formGroup]="form"
            class="max-content"
            novalidate
            [class.disabled]="denyLoading || acceptLoading || footerState.loading">
            <form-footer
                [state]="footerState"
                (save)="save()"
                (edit)="goToEdit()"
                (dismiss)="goToView()"
                (back)="goBack()">
                @if (mode != "create" && user.accountRequestDemand) {
                    <button
                        type="submit"
                        (click)="deny()"
                        i18n="Edit user|Deny account request button label@@editUserDenyAccountRequestButton"
                        class="Button">
                        Deny creation
                        @if (!denyLoading) {
                            <span>
                                <i class="fas fa-times"></i>
                            </span>
                        }
                        @if (denyLoading) {
                            <span>
                                <i class="fa fa-cog fa-spin"></i>
                            </span>
                        }
                    </button>
                }
                @if (mode != "create" && user.extensionRequestDemand) {
                    <button
                        type="submit"
                        (click)="deny()"
                        i18n="Edit user|Deny extension request button label@@editUserDenyExtensionRequestButton"
                        class="Button">
                        Deny extension
                        @if (!denyLoading) {
                            <span>
                                <i class="fas fa-times"></i>
                            </span>
                        }
                        @if (denyLoading) {
                            <span>
                                <i class="fa fa-cog fa-spin"></i>
                            </span>
                        }
                    </button>
                }
                @if (mode != "create" && (user.accountRequestDemand || user.extensionRequestDemand)) {
                    <button
                        type="submit"
                        (click)="accept()"
                        i18n="Edit user|Accept account request button label@@editUserAcceptAccountRequestButton"
                        [disabled]="!form.valid">
                        Accept
                        @if (!acceptLoading) {
                            <span>
                                <i class="fas fa-check"></i>
                            </span>
                        }
                        @if (acceptLoading) {
                            <span>
                                <i class="fa fa-cog fa-spin"></i>
                            </span>
                        }
                    </button>
                }
                @if (mode == "view" && user.id == keycloakService.getUserId()) {
                    <button
                        type="submit"
                        (click)="changePassword()"
                        i18n="Edit user|Accept account request button label@@editUserAcceptAccountRequestButton">
                        Change password
                    </button>
                }
            </form-footer>
            @if (mode == "create") {
                <h2 class="header command-zone" i18n="Create user|Title@@createUserTitle">Create user</h2>
            }
            @if (mode != "create") {
                <h2 class="header command-zone" i18n="Edit user|Title@@editUserTitle">Edit user</h2>
            }
            <fieldset>
                <ol>
                    <li>
                        <label i18n="Edit user|First name label@@editUserFirstName">First Name</label>
                        <span class="right-col">
                            @switch (mode) {
                                @case ("view") {
                                    {{ user.firstName }}
                                }
                                @default {
                                    <input type="text" id="firstName" formControlName="firstName" />
                                }
                            }
                            @if (hasError("firstName", ["required"])) {
                                <label
                                    class="form-validation-alert"
                                    i18n="Edit user|First name required error@@editUserFirstNameRequiredError">
                                    First Name is required!
                                </label>
                            }
                            @if (hasError("firstName", ["length"])) {
                                <label
                                    class="form-validation-alert"
                                    i18n="Edit user|First name length error@@editUserFirstNameLengthError">
                                    First Name length must be between 2 and 50!
                                </label>
                            }
                        </span>
                    </li>
                    <li>
                        <label i18n="Edit user|Last name label@@editUserLastName">Last Name</label>
                        <span class="right-col">
                            @switch (mode) {
                                @case ("view") {
                                    {{ user.lastName }}
                                }
                                @default {
                                    <input type="text" id="lastName" formControlName="lastName" />
                                }
                            }
                            @if (hasError("lastName", ["required"])) {
                                <label
                                    class="form-validation-alert"
                                    i18n="Edit user|Last name required error@@editUserLastNameRequiredError">
                                    Last Name is required!
                                </label>
                            }
                            @if (hasError("lastName", ["length"])) {
                                <label
                                    class="form-validation-alert"
                                    i18n="Edit user|Last name length error@@editUserLastNameLengthError">
                                    Last Name length must be between 2 and 50!
                                </label>
                            }
                        </span>
                    </li>
                    @if (mode != "create") {
                        <li>
                            <label i18n="Edit user|Username label@@editUserUsername">Username</label>
                            <span class="right-col">
                                {{ user.username }}
                            </span>
                        </li>
                    }
                    <li>
                        <label i18n="Edit user|Email label@@editUserEmail">Email</label>
                        <span class="right-col">
                            @switch (mode) {
                                @case ("view") {
                                    {{ user.email }}
                                }
                                @default {
                                    <input type="email" id="email" formControlName="email" />
                                }
                            }
                            @if (hasError("email", ["required"])) {
                                <label
                                    class="form-validation-alert"
                                    i18n="Edit user|Email required error@@editUserEmailRequiredError">
                                    Email is required!
                                </label>
                            }
                            @if (hasError("email", ["pattern"])) {
                                <label
                                    class="form-validation-alert"
                                    i18n="Edit user|Email pattern error@@editUserEmailPatternError">
                                    Email should be valid!
                                </label>
                            }
                            @if (hasError("email", ["unique"])) {
                                <label
                                    class="form-validation-alert"
                                    i18n="Edit user|Email unique error@@editUserEmailUniqueError">
                                    Email should be unique!
                                </label>
                            }
                        </span>
                    </li>
                </ol>
            </fieldset>
            <fieldset>
                <ol>
                    <li>
                        <label i18n="Edit user|Expiration date label@@editUserExpirationDate">Expiration Date</label>
                        <span class="right-col">
                            @if (mode == "view" || !isUserAdmin()) {
                                {{ user.expirationDate | localDateFormatPipe }}
                            }
                            @if (mode != "view" && isUserAdmin()) {
                                <datepicker formControlName="expirationDate"></datepicker>
                                @if (hasError("expirationDate", ["format"])) {
                                    <label
                                        class="form-validation-alert"
                                        i18n="Edit user|Date valid error@@editUserDateValidError">
                                        Date should be valid! Date format: {{ dateDisplay }}
                                    </label>
                                }
                                @if (hasError("expirationDate", ["future"])) {
                                    <label
                                        class="form-validation-alert"
                                        i18n="Edit user|Date valid error@@editUserDateFutureError">
                                        This date should be in the future!
                                    </label>
                                }
                            }
                        </span>
                    </li>
                    <li class="required">
                        <label i18n="Edit user|Role label@@editUserRole">Role of the user</label>
                        <span class="right-col">
                            @if (mode == "view" || !isUserAdmin()) {
                                {{ user.role.displayName }}
                            }
                            @if (mode != "view" && isUserAdmin()) {
                                <select id="role" formControlName="role">
                                    @for (role of roles; track role) {
                                        <option [ngValue]="role">{{ role.displayName }}</option>
                                    }
                                </select>
                                @if (hasError("role", ["required"])) {
                                    <label
                                        class="form-validation-alert"
                                        i18n="Edit user|Role required error@@editUserRoleRequiredError">
                                        Role is required!
                                    </label>
                                }
                            }
                        </span>
                    </li>
                    <li>
                        <label
                            i18n="Edit user|CanAccess to Dicom association label@@editUserCanAccessToDicomAssociation">
                            Can import from PACS
                        </label>
                        <span class="right-col">
                            @if (mode == "view" || !isUserAdmin()) {
                                @if (user.canAccessToDicomAssociation) {
                                    <span class="bool-true"><i class="fas fa-check"></i></span>
                                }
                                @if (!user.canAccessToDicomAssociation) {
                                    <span class="bool-false"><i class="fas fa-times"></i></span>
                                }
                            }
                            @if (mode != "view" && isUserAdmin()) {
                                <checkbox formControlName="canAccessToDicomAssociation"></checkbox>
                            }
                        </span>
                    </li>
                </ol>
            </fieldset>
            @if (isUserAdmin()) {
                <fieldset>
                    <legend>Joined studies</legend>
                    @if (studies?.length > 0) {
                        <ol>
                            @for (study of studies; track study; let index = $index) {
                                <li class="userStudies">
                                    <span class="studyName">{{ study?.name + " (" + study?.id + ")" }}</span>
                                    @if (mode == "edit") {
                                        <span>
                                            <span class="right-col">
                                                <button
                                                    type="button"
                                                    class="deleteButton"
                                                    (click)="removeStudyFromUser(study, index)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </span>
                                        </span>
                                    }
                                </li>
                            }
                        </ol>
                    } @else {
                        <ol>
                            <li>none</li>
                        </ol>
                    }
                </fieldset>
            }
            @if (user.accountRequestDemand) {
                <fieldset>
                    <legend class="right-icon">Account request details</legend>
                    <account-request-info formControlName="accountRequestInfo"></account-request-info>
                </fieldset>
            }
            @if (user.extensionRequestDemand) {
                <fieldset>
                    <ol>
                        <li>
                            <label i18n="Extension comment |Extension comment label@@editUserExtensionComment">
                                Extension comment
                            </label>
                            <span class="right-col">
                                <textarea autosize formControlName="extensionMotivation" readonly></textarea>
                            </span>
                        </li>
                    </ol>
                </fieldset>
            }
        </form>
    }
</div>
