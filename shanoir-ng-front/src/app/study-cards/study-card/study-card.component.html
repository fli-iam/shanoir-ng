<!--
Shanoir NG - Import, manage and share neuroimaging data
Copyright (C) 2009-2019 Inria - https://www.inria.fr/
Contact us on https://project.inria.fr/shanoir/

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

You should have received a copy of the GNU General Public License
along with this program. If not, see https://www.gnu.org/licenses/gpl-3.0.html
-->
<div #formContainer class="content-component">
    @if (form) {
        <form [formGroup]="form" class="max-content" novalidate [class.disabled]="footerState.loading">
            <div class="layout">
                <form-footer
                    [state]="footerState"
                    (save)="save()"
                    (delete)="delete()"
                    (edit)="goToEdit()"
                    (dismiss)="goToView()"
                    (back)="goBack()">
                    @if (mode != "view") {
                        <button
                            type="button"
                            class="Button right-icon show-errors"
                            (click)="onShowErrors()"
                            [disabled]="
                                !footerState.dirty ||
                                footerState.valid ||
                                showRulesErrors ||
                                studyCard.rules?.length == 0
                            ">
                            Show all errors
                            <i class="fas fa-bug"></i>
                        </button>
                    }
                    @if (selectMode) {
                        <button
                            class="Button right-icon"
                            (click)="clickImportRules()"
                            [disabled]="selectedRules.length <= 0">
                            Import selected rules
                            <i class="fas fa-file-import"></i>
                        </button>
                    }
                    @if (mode == "view" && isAdminOrExpert) {
                        <button type="button" class="Button right-icon" (click)="goToApply()">
                            Reapply study card
                            <i class="fas fa-cogs"></i>
                        </button>
                    }
                </form-footer>
                <span>
                    @switch (mode) {
                        @case ("view") {
                            <h2 class="header command-zone">Details on study card</h2>
                        }
                        @case ("edit") {
                            <h2 class="header command-zone">Edit study card</h2>
                        }
                        @case ("create") {
                            <h2 class="header command-zone">Create study card</h2>
                        }
                    }
                </span>
                <fieldset>
                    <ol>
                        <li>
                            <label>Name</label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("view") {
                                        {{ studyCard.name }}
                                    }
                                    @default {
                                        <input type="text" formControlName="name" />
                                        @if (hasError("name", ["required"])) {
                                            <label
                                                [@slideDown]="hasError('name', ['required'])"
                                                class="form-validation-alert">
                                                Name is required!
                                            </label>
                                        }
                                        @if (hasError("name", ["minlength", "maxlength"])) {
                                            <label
                                                [@slideDown]="hasError('name', ['minlength'])"
                                                class="form-validation-alert">
                                                Too short!
                                            </label>
                                        }
                                        @if (hasError("name", ["unique"])) {
                                            <label
                                                [@slideDown]="hasError('name', ['unique'])"
                                                class="form-validation-alert">
                                                Name should be unique!
                                            </label>
                                        }
                                    }
                                }
                            </span>
                        </li>
                        <li>
                            <label>Study</label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("view") {
                                        <a [routerLink]="['/study/details/', studyCard.study?.id]">
                                            {{ studyCard.study.name }}
                                        </a>
                                    }
                                    @default {
                                        <select-box
                                            formControlName="study"
                                            [optionArr]="studies"
                                            [disabled]="lockStudy"></select-box>
                                    }
                                }
                            </span>
                        </li>
                        <li>
                            <label>Acquisition Center(s)</label>
                            @if (studyCard.study) {
                                <span class="right-col">
                                    @switch (mode) {
                                        @case ("view") {
                                            {{ studyCard.acquisitionEquipment?.center?.name }}
                                        }
                                        @default {
                                            @for (center of centers; track center) {
                                                <span class="center">
                                                    {{ center.name }}
                                                </span>
                                            }
                                        }
                                    }
                                </span>
                            }
                        </li>
                        <li>
                            <label>Center equipment</label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("view") {
                                        <a
                                            [routerLink]="[
                                                '/acquisition-equipment/details/',
                                                studyCard.acquisitionEquipment?.id,
                                            ]">
                                            {{ studyCard.acquisitionEquipment | acqEqptLabel }}
                                        </a>
                                    }
                                    @default {
                                        <select-box
                                            formControlName="acquisitionEquipment"
                                            (userChange)="onChangeAcqEq()"
                                            [options]="acquisitionEquipments"
                                            (newClick)="createAcqEq()"></select-box>
                                    }
                                }
                            </span>
                        </li>
                    </ol>
                </fieldset>
                <fieldset class="rules">
                    <legend>
                        Rules
                        <tool-tip [large]="true">
                            There are two differents types of rules for a studycard :
                            <ul>
                                <li>
                                    <span class="bold">Rules that apply to every dataset of the acquisition :</span>
                                    each dataset is checked regarding the conditions of that one rule and updated
                                    regarding the assignments of that one rule.
                                </li>
                                <li>
                                    <span class="bold">Rules that apply to the acquisition :</span>
                                    conditions on the acquisition's metadata can be set as well as the minimal number of
                                    datasets that fullfil one given condition, then an assignment is applied to that
                                    acquisition.
                                </li>
                            </ul>
                        </tool-tip>
                    </legend>
                    <study-card-rules
                        class="rules"
                        [formGroup]="form"
                        cardType="studycard"
                        formControlName="rules"
                        [mode]="selectMode ? 'select' : mode"
                        [manufModelId]="studyCard.acquisitionEquipment?.manufacturerModel?.id"
                        [allCoils]="allCoils"
                        [showErrors]="showRulesErrors"
                        (selectedRulesChange)="selectedRules = $event"
                        (importRules)="importRules()"
                        [addSubForm]="addConditionForm.bind(this)"></study-card-rules>
                </fieldset>
            </div>
        </form>
    }
</div>
