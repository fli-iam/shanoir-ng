<!--
Shanoir NG - Import, manage and share neuroimaging data
Copyright (C) 2009-2019 Inria - https://www.inria.fr/
Contact us on https://project.inria.fr/shanoir/

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

You should have received a copy of the GNU General Public License
along with this program. If not, see https://www.gnu.org/licenses/gpl-3.0.html
-->

<span>if,&nbsp;</span>
@if (mode == "view") {
    <span class="view">
        @if (condition.cardinality == -1) {
            <span class="cardinality-type">for every</span>
        }
        @if (condition.cardinality == 0) {
            <span class="cardinality-type">for no</span>
        }
        @if (condition.cardinality > 0) {
            <span class="cardinality-type">for at least</span>
        }
        @if (condition.cardinality > 0) {
            <span class="cardinality">{{ condition.cardinality }}</span>
        }
        <span>
            dataset
            @if (condition.cardinality > 1) {
                s
            }
            in the exam,
        </span>
        @if (condition.scope == "StudyCardDICOMConditionOnDatasets") {
            <span class="var" title="{{ condition.dicomTag | dicomTagLabel }}">
                {{ condition.dicomTag?.label ? condition.dicomTag.label : (condition.dicomTag?.code | dicomTagLabel) }}
            </span>
        }
        @if (condition.scope != "StudyCardDICOMConditionOnDatasets") {
            <span class="var">{{ fieldLabel }}</span>
        }
        <span class="method">
            @if (condition.operation == "EQUALS") {
                <i class="fa-solid fa-equals"></i>
            }
            @if (condition.operation == "NOT_EQUALS") {
                <i class="fa-solid fa-not-equal"></i>
            }
            @if (condition.operation == "SMALLER_THAN") {
                <i class="fa-solid fa-less-than"></i>
            }
            @if (condition.operation == "BIGGER_THAN") {
                <i class="fa-solid fa-greater-than"></i>
            }
            @if (!["EQUALS", "NOT_EQUALS", "SMALLER_THAN", "BIGGER_THAN"].includes(condition.operation)) {
                {{ condition.operation }}
            }
        </span>
        @if (condition.type == "string") {
            <span class="multi-value">
                @for (value of condition.values; track value; let i = $index) {
                    <div class="value">
                        @if (i > 0) {
                            <span class="or">or</span>
                        }
                        "{{ value }}"
                    </div>
                }
            </span>
        }
        @if (condition.type == "Coil") {
            <span class="multi-value">
                @for (coil of condition.values; track coil; let i = $index) {
                    <div class="value">
                        @if (i > 0) {
                            <span class="or">or</span>
                        }
                        {{ coil['name'] || coil['id'] || coil }}
                    </div>
                }
            </span>
        }
    </span>
}
@if (mode != "view" && init) {
    <select-box
        class="cardinality-type auto-width"
        [(ngModel)]="cardinalityType"
        (userChange)="onCardinalityTypeChange()"
        [clear]="false"
        placeholder="select cardinality"
        [search]="false"
        [options]="[
            { label: 'for no', value: 'NONE' },
            { label: 'for every', value: 'ALL' },
            { label: 'for at least', value: 'AT_LEAST' },
        ]"></select-box>
    @if (cardinalityType == "AT_LEAST") {
        <input
            type="number"
            class="cardinality auto-width"
            [(ngModel)]="condition.cardinality"
            [class.error]="cardinalityError"
            min="1"
            [style.width]="(condition.cardinality ? (condition.cardinality + '').length + 3 : '4') + 'ch'" />
    }
    <span>
        dataset
        @if (condition.cardinality > 1) {
            s
        }
        in the exam,
    </span>
    <select-box
        class="type auto-width"
        [ngModel]="condition.scope"
        (userChange)="onConditionTypeChange($event)"
        [options]="conditionTypeOptions"
        placeholder="select conditition type"
        [clear]="false"></select-box>
    @if (condition.scope == "StudyCardDICOMConditionOnDatasets") {
        <select-box
            class="var auto-width"
            [class.error]="tagError"
            [(ngModel)]="condition.dicomTag"
            (userChange)="onDicomFieldChange($event)"
            [options]="tagOptions"
            placeholder="select dicom tag"
            (focusout)="tagTouched = true"
            [clear]="false"></select-box>
    }
    @if (condition.scope != "StudyCardDICOMConditionOnDatasets") {
        <select-box
            class="var auto-width"
            [class.error]="shanoirFieldError"
            [(ngModel)]="condition.shanoirField"
            (userChange)="onFieldChange()"
            [options]="fieldOptions"
            placeholder="select shanoir metadata field"
            (focusout)="shanoirFieldTouched = true"
            [clear]="false"></select-box>
    }
    <select-box
        [readOnly]="condition.shanoirField && shanoirFieldOptions?.length > 0"
        class="method auto-width"
        [class.error]="operationError"
        [(ngModel)]="condition.operation"
        (userChange)="onOperationChange()"
        [options]="operations"
        placeholder="select operation"
        (focusout)="operationTouched = true"
        [clear]="false"></select-box>
    @if (condition?.operation != "PRESENT" && condition?.operation != "ABSENT") {
        <form [formGroup]="form">
            @if (condition.scope == "StudyCardDICOMConditionOnDatasets" || !(shanoirFieldOptions?.length > 0)) {
                <span formArrayName="values" class="multi-value edit">
                    @for (value of condition.values; track trackByFn(i); let i = $index) {
                        <span class="one-value">
                            <auto-ajust-input
                                [formControlName]="i"
                                class="value"
                                [(ngModel)]="condition.values[i]"
                                (userChange)="onConditionChange()"
                                placeholder="enter value"
                                (focusout)="valueTouched = true"></auto-ajust-input>
                            @if (condition.values.length > 1) {
                                <span class="delete-value" (click)="onTextValueRemove(i)">
                                    <i class="far fa-times-circle"></i>
                                </span>
                            }
                        </span>
                    }
                    @if (!(condition.values[condition.values.length - 1]?.toString().length == 0)) {
                        <div class="add-cond-value-frame">
                            <span class="add-cond-value" (click)="onTextValueAdd()">
                                <i class="fa-solid fa-circle-plus"></i>
                                Add a possible value
                            </span>
                        </div>
                    }
                </span>
            }
            @if (condition.scope != "StudyCardDICOMConditionOnDatasets" && shanoirFieldOptions?.length > 0) {
                <span formArrayName="values" class="multi-value edit">
                    @for (value of condition.values; track value; let i = $index) {
                        <select-box
                            [formControlName]="i"
                            class="value auto-width one-value"
                            [(ngModel)]="condition.values[i]"
                            (userChange)="onConditionValueChange()"
                            (selectOption)="onConditionOptionSelect($event)"
                            (userClear)="onConditionOptionUnselect($event)"
                            [options]="shanoirFieldOptions"
                            placeholder="select value"
                            (focusout)="valueTouched = true"></select-box>
                    }
                    @if (
                        condition.values[condition.values.length - 1] &&
                        condition.values.length < shanoirFieldOptions.length
                    ) {
                        <div class="add-cond-value-frame">
                            <span class="add-cond-value" (click)="condition.values?.push(null)">
                                <i class="fa-solid fa-plus"></i>
                                Add a possible value
                            </span>
                        </div>
                    }
                </span>
            }
        </form>
    }
}
@if (mode != "view") {
    <span class="delete" (click)="delete.emit()"><i class="far fa-times-circle"></i></span>
}
