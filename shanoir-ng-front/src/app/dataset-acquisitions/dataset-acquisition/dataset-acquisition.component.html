<!--
Shanoir NG - Import, manage and share neuroimaging data
Copyright (C) 2009-2019 Inria - https://www.inria.fr/
Contact us on https://project.inria.fr/shanoir/

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

You should have received a copy of the GNU General Public License
along with this program. If not, see https://www.gnu.org/licenses/gpl-3.0.html
-->

<div #formContainer class="content-component">
    @if (form) {
        <form [formGroup]="form" class="max-content" novalidate [class.disabled]="footerState.loading">
            <div class="layout">
                <form-footer
                    [state]="footerState"
                    (save)="save()"
                    (edit)="goToEdit()"
                    (delete)="delete()"
                    (dismiss)="goToView()"
                    (back)="goBack()">
                    @if (mode == "view" && hasDownloadRight && !noDatasets) {
                        <button
                            class="right-icon dl-button"
                            type="button"
                            (click)="downloadAll()"
                            [disabled]="downloadState?.isActive()">
                            Download
                            <i class="fas fa-download"></i>
                        </button>
                    }
                </form-footer>
                <span>
                    @switch (mode) {
                        @case ("view") {
                            <h2 class="header command-zone">Details on dataset acquisition</h2>
                        }
                        @case ("edit") {
                            <h2 class="header command-zone">Edit dataset acquisition</h2>
                        }
                        @case ("create") {
                            <h2 class="header command-zone">Create dataset acquisition</h2>
                        }
                    }
                </span>
                <fieldset>
                    <ol>
                        @if (mode != "create") {
                            <li>
                                <label>Id</label>
                                <span class="right-col">
                                    {{ datasetAcquisition.id }}
                                </span>
                            </li>
                        }
                        <li>
                            <label>Type</label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("view") {
                                        {{ datasetAcquisition.type }}
                                    }
                                    @default {
                                        <select-box
                                            formControlName="type"
                                            [optionArr]="['Mr', 'Pet', 'Ct']"></select-box>
                                    }
                                }
                            </span>
                        </li>
                        <li>
                            <label>Study</label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("view") {
                                        <a
                                            [routerLink]="[
                                                '/study/details/',
                                                datasetAcquisition.examination?.study?.id,
                                            ]">
                                            {{ datasetAcquisition.examination?.study?.name }}
                                        </a>
                                    }
                                }
                            </span>
                        </li>
                        <li>
                            <label>Examination</label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("view") {
                                        <a [routerLink]="['/examination/details/', datasetAcquisition.examination?.id]">
                                            {{
                                                datasetAcquisition?.examination?.comment
                                                    ? datasetAcquisition?.examination?.comment
                                                    : (datasetAcquisition?.examination?.examinationDate
                                                      | localDateFormatPipe)
                                            }}
                                        </a>
                                    }
                                }
                            </span>
                        </li>
                        <li>
                            <label>Study card</label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("view") {
                                        <a [routerLink]="['/study-card/details/', datasetAcquisition.studyCard?.id]">
                                            {{ datasetAcquisition.studyCard?.name }}
                                        </a>
                                    }
                                    @default {
                                        <select-box formControlName="studyCard" [optionArr]="studyCards"></select-box>
                                    }
                                }
                            </span>
                        </li>
                        <li>
                            <label>Import date</label>
                            @if (mode == "view") {
                                <span class="right-col">
                                    {{ datasetAcquisition.importDate }}
                                </span>
                            }
                        </li>
                        <li>
                            <label>Imported by user</label>
                            @if (mode == "view") {
                                <span class="right-col">
                                    {{ datasetAcquisition.username }}
                                </span>
                            }
                        </li>
                        <li>
                            <label>Center equipment</label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("view") {
                                        @if (datasetAcquisition.acquisitionEquipment?.id) {
                                            <a
                                                [routerLink]="[
                                                    '/acquisition-equipment/details/',
                                                    datasetAcquisition.acquisitionEquipment.id,
                                                ]">
                                                {{ datasetAcquisition.acquisitionEquipment | acqEqptLabel }}
                                            </a>
                                        }
                                    }
                                    @default {
                                        <select-box
                                            formControlName="acquisitionEquipment"
                                            [optionArr]="acquisitionEquipments"
                                            [pipe]="acqEqPipe"></select-box>
                                    }
                                }
                            </span>
                        </li>
                        <li>
                            <label>Rank</label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("view") {
                                        {{ datasetAcquisition.rank }}
                                    }
                                    @default {
                                        <input type="text" formControlName="rank" />
                                    }
                                }
                            </span>
                        </li>
                        <li>
                            <label>Acquisition start time</label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("view") {
                                        {{ datasetAcquisition.acquisitionStartTime | localDateFormatPipe: true }}
                                    }
                                    @default {
                                        <input type="text" formControlName="acquisitionStartTime" />
                                    }
                                }
                            </span>
                        </li>
                        <li>
                            <label>Software release</label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("view") {
                                        {{ datasetAcquisition.softwareRelease }}
                                    }
                                    @default {
                                        <input type="text" formControlName="softwareRelease" />
                                    }
                                }
                            </span>
                        </li>
                        <li>
                            <label>Sorting index</label>
                            <span class="right-col">
                                @switch (mode) {
                                    @case ("view") {
                                        {{ datasetAcquisition.sortingIndex }}
                                    }
                                    @default {
                                        <input type="text" formControlName="sortingIndex" />
                                    }
                                }
                            </span>
                        </li>
                        @if (mode != "create" && datasetAcquisition.copies?.length > 0) {
                            <li>
                                <label>This acquisition has been copied :</label>
                                <span class="right-col">
                                    @for (entityId of datasetAcquisition.copies; track entityId) {
                                        <div>
                                            <a [routerLink]="['/dataset-acquisition/details/', entityId]">
                                                [ {{ entityId }} ]
                                            </a>
                                        </div>
                                    }
                                </span>
                            </li>
                        }
                        @if (mode != "create" && datasetAcquisition.source != null) {
                            <li>
                                <label>This acquisition is the copy of :</label>
                                <span class="right-col">
                                    <a [routerLink]="['/dataset-acquisition/details/', datasetAcquisition.source]">
                                        [ {{ datasetAcquisition.source }} ]
                                    </a>
                                </span>
                            </li>
                        }
                    </ol>
                </fieldset>
                @if (datasetAcquisition.protocol) {
                    @if (datasetAcquisition.type == "Mr") {
                        <mr-protocol formControlName="protocol"></mr-protocol>
                    }
                    @if (datasetAcquisition.type == "Ct") {
                        <ct-protocol formControlName="protocol"></ct-protocol>
                    }
                    @if (datasetAcquisition.type == "Pet") {
                        <pet-protocol formControlName="protocol"></pet-protocol>
                    }
                    @if (datasetAcquisition.type == "Xa") {
                        <xa-protocol formControlName="protocol"></xa-protocol>
                    }
                }
                @if (downloadState.status > 1) {
                    <progress-bar
                        [progress]="downloadState?.progress"
                        [text]="'Preparing download'"
                        [unknownDownload]="true"></progress-bar>
                }
            </div>
        </form>
    }
</div>
