<!--
Shanoir NG - Import, manage and share neuroimaging data
Copyright (C) 2009-2019 Inria - https://www.inria.fr/
Contact us on https://project.inria.fr/shanoir/

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

You should have received a copy of the GNU General Public License
along with this program. If not, see https://www.gnu.org/licenses/gpl-3.0.html
-->

<ng-template #tableRow let-item="rowItem" let-itemIndex="i" let-columnDefs="columnDefinitions">
    @for (col of columnDefs; track col; let colIndex = $index) {
        <ng-container
            *ngVar="{
                render: renderCell(item, col),
                route: col.route ? col.route(item) : null,
                boolean: isFieldBoolean(col),
                editable: cellEditable(item, col),
                rowRoute: rowRoute ? rowRoute(item) : null,
                possibleValues:
                    page?._savedContentRendering && page?._savedContentRendering[itemIndex]
                        ? page._savedContentRendering[itemIndex][colIndex]?.possibleValues
                        : null,
                cellValue: getCellValue(item, col),
                cellGraphics: getCellGraphics(item, col),
            } as vars">
            @if (!col.hidden) {
                <td
                    class="cell cell-{{ $any(col).field != undefined ? $any(col).field : 'nofield' }} {{
                        getCellTypeStr(col)
                    }}"
                    [class.bool]="vars.boolean"
                    [class.progress]="col.type == 'progress'"
                    [class.multi]="editMode && col.multi"
                    [attr.title]="col.tip != undefined ? col.tip(item) : vars.render.text ? vars.render.text : ''"
                    [style.color]="vars.render?.color"
                    [style.background-color]="vars.cellGraphics?.tag ? null : vars.cellGraphics?.backgroundColor"
                    #refTd>
                    @if (col.type != "button") {
                        <div
                            class="cell-container"
                            (click)="col.type == 'button' ? null : onRowClick(item)"
                            [class.table-edit]="editMode"
                            [class.select]="!!col.possibleValues"
                            [class.multiselect]="!!col.possibleValues && col.multi"
                            [class.wrap]="col.wrap">
                            <!-- default display -->
                            @if (
                                !(editMode && vars.editable) &&
                                !vars.route &&
                                !vars.boolean &&
                                col.type != "progress" &&
                                !col.multi &&
                                col.type != "button"
                            ) {
                                <a class="cell-new-tab" [routerLink]="vars.rowRoute">
                                    <span
                                        class="default-data-parent"
                                        title="{{ vars.render.text ? vars.render.text : vars.render }}"
                                        [style.color]="vars.cellGraphics?.color"
                                        [style.border-color]="vars.cellGraphics?.tag ? vars.cellGraphics?.color : null"
                                        [style.background-color]="
                                            vars.cellGraphics?.tag ? vars.cellGraphics?.backgroundColor : null
                                        "
                                        [class.block]="vars.cellGraphics?.tag">
                                        @if (vars.cellGraphics?.awesome) {
                                            <i class="{{ vars.cellGraphics.awesome }}"></i>
                                        }
                                        {{ vars.render.text ? vars.render.text : vars.render }}
                                    </span>
                                </a>
                            }
                            <!-- link -->
                            @if (!(editMode && vars.editable) && vars.route && !col.multi) {
                                <a
                                    [routerLink]="vars.rowRoute"
                                    class="cell-new-tab"
                                    title="{{ vars.render.text ? vars.render.text : vars.render }}">
                                    <a
                                        class="link"
                                        [routerLink]="item.eventType != 'downloadStatistics.event' ? vars.route : null"
                                        routerLinkActive="active"
                                        (click)="downloadStats(item)">
                                        {{ vars.render.text ? vars.render.text : vars.render }}
                                        @if (!col.awesome) {
                                            <i class="fas fa-external-link-alt"></i>
                                        }
                                        @if (col.awesome) {
                                            <span class="awesome">
                                                @if (col.awesome) {
                                                    <i [class]="col.awesome"></i>
                                                }
                                            </span>
                                        }
                                    </a>
                                </a>
                            }
                            <!-- multi -->
                            @if (!editMode && col.multi) {
                                <a [routerLink]="vars.rowRoute" class="cell-new-tab">
                                    @for (oneVal of getFieldRawValue(item, col["field"]); track oneVal) {
                                        <span
                                            class="block"
                                            [style.color]="oneVal.backgroundColor"
                                            [style.background-color]="oneVal.color"
                                            [class.dark]="getFontColor(oneVal.color)">
                                            <span class="label">
                                                {{ oneVal.label ? oneVal.label : oneVal.name ? oneVal.name : oneVal }}
                                            </span>
                                        </span>
                                    }
                                </a>
                            }
                            <!-- display a boolean -->
                            @if (vars.boolean && (!editMode || !vars.editable)) {
                                <a [routerLink]="vars.rowRoute" class="cell-new-tab">
                                    @if (vars.cellValue == true && !col.awesome && !col.awesomeFalse) {
                                        <span class="bool-true"><i class="fas fa-check"></i></span>
                                    }
                                    @if (vars.cellValue == false && !col.awesome && !col.awesomeFalse) {
                                        <span class="bool-false"><i class="fas fa-times"></i></span>
                                    }
                                    @if (vars.cellValue == true && col.awesome) {
                                        <span class="bool-true">
                                            <i [class]="col.awesome" [style.color]="col.color"></i>
                                        </span>
                                    }
                                    @if (!vars.cellValue && col.awesomeFalse) {
                                        <span class="bool-false">
                                            <i [class]="col.awesomeFalse" [style.color]="col.colorFalse"></i>
                                        </span>
                                    }
                                </a>
                            }
                        </div>
                    }
                    <!-- editable boolean -->
                    @if (vars.boolean && editMode && vars.editable) {
                        <checkbox
                            [ngModel]="vars.cellValue"
                            (ngModelChange)="onFieldEdit(item, col, $event)"></checkbox>
                    }
                    <!-- editable text / number -->
                    @if (
                        editMode && vars.editable && (isColumnText(col) || isColumnNumber(col)) && !vars.possibleValues
                    ) {
                        <input
                            type="text"
                            [ngModel]="getFieldRawValue(item, col['field'])"
                            (ngModelChange)="onFieldEdit(item, col, $event)" />
                    }
                    <!-- editable with dropdown -->
                    @if (
                        editMode && vars.editable && (isColumnText(col) || isColumnNumber(col)) && vars.possibleValues
                    ) {
                        <!-- single -->
                        @if (!col.multi) {
                            <select
                                [ngModel]="getFieldRawValue(item, col['field'])"
                                (ngModelChange)="onFieldEdit(item, col, $event)">
                                @for (possibleValue of vars.possibleValues; track possibleValue) {
                                    <option [value]="possibleValue.value">{{ possibleValue.label }}</option>
                                }
                            </select>
                        }
                        <!-- multi -->
                        @if (col.multi) {
                            <multi-select
                                [ngModel]="getFieldRawValue(item, col['field'])"
                                (ngModelChange)="onFieldEdit(item, col, $event)"
                                [options]="vars.possibleValues"></multi-select>
                        }
                    }
                    <!-- display a button -->
                    @if (
                        col.type == "button" &&
                        !rowDisabled(item) &&
                        col.action &&
                        (!col.condition || col.condition(item))
                    ) {
                        <span class="button" (click)="col.action(item)">
                            @if (col.img) {
                                <img src="{{ col.img }}" alt="image {{ col.title }}" />
                            }
                            @if (col.awesome) {
                                <span class="awesome"><i [class]="col.awesome"></i></span>
                            }
                        </span>
                    }
                    <!-- display a progress bar -->
                    @if (col.type == "progress") {
                        <progress-bar
                            [progress]="vars.render?.progress != undefined ? vars.render?.progress : vars.render"
                            width="100"
                            [warning]="vars.render?.status == 5 || vars.render?.status == 3"></progress-bar>
                    }
                    @if (colIndex < columnDefs.length - 1) {
                        <div
                            class="resizer"
                            (mousedown)="startDrag(colIndex, refTd, $event, columnDefs)"
                            (mouseup)="stopDrag()"></div>
                    }
                </td>
            }
        </ng-container>
    }
</ng-template>

<ng-template #th let-col="column" let-i="index" let-columnDefs="columnDefinitions" let-sub="subRows">
    @if (!col.hidden) {
        <th
            class="{{ getColTypeStr(col) }}"
            [class.sortable]="!col.disableSorting && col.type != 'button'"
            [class.active]="lastSortedCol == col"
            [attr.title]="col.headerName"
            [style.width]="col.width"
            [class.sub-header]="sub"
            #refTh>
            @if (!sub && $any(lastSortedCol)?.field == $any(col).field && !col.disableSorting && col.type != "button") {
                <span class="triangle" [class.down]="lastSortedAsc" [class.up]="!lastSortedAsc">
                    <svg viewBox="0 0 100 100" preserveAspectRatio="none">
                        @if (lastSortedAsc) {
                            <polygon points="0,0 100,0 50,100" />
                        }
                        @if (!lastSortedAsc) {
                            <polygon points="0,100 100,100 50,0" />
                        }
                    </svg>
                </span>
            }
            @if (!sub) {
                <div class="click-dummy" (click)="sortBy(col)" [class.resizing]="currentDrag"></div>
            }
            <span class="col-title">{{ col.headerName }}</span>
            @if (i < columnDefs.length - 1) {
                <div class="resizer" (mousedown)="startDrag(i, refTh, $event, columnDefs)" (mouseup)="stopDrag()"></div>
            }
        </th>
    }
</ng-template>

<!-- Control bar -->
@if (selectionAllowed || browserSearch || customActionDefs?.length > 0) {
    <caption class="controls">
        @if (selectionAllowed) {
            <span class="select-ctrl" [class.with-sub]="subRowsDefs">
                <checkbox [(ngModel)]="selectAll" (ngModelChange)="onSelectAllChange()"></checkbox>
            </span>
        }
        <span class="ctrl-right" [class.with-sub]="subRowsDefs">
            <!-- Text search -->
            @if (browserSearch) {
                <span class="text-search">
                    <shanoir-table-search
                        #search
                        [columnDefs]="columnDefs"
                        [(filter)]="filter"
                        (filterChange)="onSearchChange($event)"></shanoir-table-search>
                </span>
            }
            <!-- User defined buttons -->
            @for (command of customActionDefs; track command) {
                <span class="command-block">
                    @if (command.target != undefined) {
                        <button
                            type="button"
                            [routerLink]="command.target"
                            [queryParams]="command.getParams != undefined ? command.getParams() : null"
                            routerLinkActive="active"
                            [disabled]="
                                (command.disabledIfNoSelected && selection.size == 0) ||
                                (command.disabledIfNoResult && items?.length == 0)
                            ">
                            @if (command.img) {
                                <img src="{{ command.img }}" alt="image {{ command.title }}" />
                            }
                            @if (command.awesome) {
                                <span class="awesome"><i class="fas {{ command.awesome }}"></i></span>
                            }
                            <span>{{ command.title }}</span>
                        </button>
                    }
                    @if (command.action != undefined) {
                        <button
                            type="button"
                            (click)="command.action()"
                            [disabled]="
                                (command.disabledIfNoSelected && selection.size == 0) ||
                                (command.disabledIfNoResult && items?.length == 0)
                            ">
                            {{ command.hasCopyRight }}
                            @if (command.img) {
                                <img src="{{ command.img }}" alt="image {{ command.title }}" />
                            }
                            @if (command.awesome) {
                                <span class="awesome"><i class="fas {{ command.awesome }}"></i></span>
                            }
                            <span>{{ command.title }}</span>
                        </button>
                    }
                </span>
            }
        </span>
    </caption>
}
<!-- Headers -->
<thead (mousemove)="moveDrag($event)">
    <tr class="full-row">
        @if (subRowsDefs) {
            <th class="checkbox-col"></th>
        }
        @if (selectionAllowed) {
            <th class="checkbox-col"></th>
        }
        @for (col of columnDefs; track col; let i = $index) {
            <ng-template
                [ngTemplateOutlet]="th"
                [ngTemplateOutletContext]="{ column: col, index: i, columnDefinitions: columnDefs }"></ng-template>
        }
    </tr>
</thead>
<!-- Table content -->
@if (items?.length > 0) {
    <tbody (mousemove)="moveDrag($event)">
        @for (item of items; track item; let i = $index) {
            <tr
                [class.odd]="i % 2 != 0"
                [class.even]="i % 2 == 0"
                [class.disabled]="rowDisabled(item)"
                [class.edit]="editMode"
                [class.selected]="(selectionAllowed && isSelected(item)) || (!!item.id && selectedId == item.id)"
                [class.opened]="subRowsDefs && subRowOpen[i]">
                @if (subRowsDefs) {
                    <td class="checkbox-cell deploy-cell">
                        @if (!subRowOpen[i]) {
                            <i (click)="deploy(i)" class="fa-solid fa-plus"></i>
                        }
                        @if (subRowOpen[i]) {
                            <i (click)="fold(i)" class="fa-solid fa-minus"></i>
                        }
                    </td>
                }
                @if (selectionAllowed) {
                    <td class="checkbox-cell">
                        <checkbox
                            (ngModelChange)="onSelectChange(item, $event)"
                            [ngModel]="isSelected(item)"></checkbox>
                    </td>
                }
                <ng-template
                    [ngTemplateOutlet]="tableRow"
                    [ngTemplateOutletContext]="{ rowItem: item, i: i, columnDefinitions: columnDefs }"></ng-template>
            </tr>
            @if (subRowsDefs && subRowOpen[i]) {
                <tr class="sub-container-tr">
                    <td class="sub-container-margin-td"></td>
                    <td [attr.colspan]="nbColumns" class="sub-container-td">
                        <table class="sub-container-table">
                            <thead>
                                @for (col of subRowsDefs; track col; let i = $index) {
                                    <ng-template
                                        [ngTemplateOutlet]="th"
                                        [ngTemplateOutletContext]="{
                                            column: col,
                                            index: i,
                                            columnDefinitions: subRowsDefs,
                                            subRows: true,
                                        }"></ng-template>
                                }
                            </thead>
                            <tbody>
                                @for (subItem of item[subRowsKey]; track subItem) {
                                    <tr>
                                        <ng-template
                                            [ngTemplateOutlet]="tableRow"
                                            [ngTemplateOutletContext]="{
                                                rowItem: subItem,
                                                i: i,
                                                columnDefinitions: subRowsDefs,
                                            }"></ng-template>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </td>
                </tr>
            }
        }
        <!-- Pager : don't insert new lines between a span closing tag and the next span opening tag, it would result as a "space" between them -->
        @if (items?.length > 0 && page?.totalPages > 1) {
            <tr class="full-row">
                <th class="pager" [attr.colspan]="nbColumns">
                    <shanoir-pager
                        [currentPage]="currentPage"
                        [nbPages]="page ? page.totalPages : 0"
                        (pageChange)="goToPage($event)"></shanoir-pager>
                </th>
            </tr>
        }
        <tr [class.collapsable]="collapseControls">
            <th class="status-bar controls" [attr.colspan]="nbColumns">
                <!-- Nb results per page input -->
                <span class="options">
                    <ng-container>
                        <span class="clickable bottom-refresh" (click)="refresh()">
                            @if (!isLoading) {
                                <span>
                                    <i class="fas fa-sync-alt"></i>
                                </span>
                            }
                            @if (isLoading) {
                                <span>
                                    <i class="fas fa-sync-alt fa-spin"></i>
                                </span>
                            }
                        </span>
                        @if (selectionAllowed) {
                            <span>Selected : {{ getNbSelected() }}</span>
                        }
                        @if (page && browserSearch) {
                            <span>Found : {{ page?.numberOfElements }}</span>
                        }
                        @if (page) {
                            <span>Total : {{ page?.totalElements }}</span>
                        }
                        <span>
                            Page size :
                            <input
                                class="max-results"
                                [(ngModel)]="maxResultsField"
                                (change)="updateMaxResults()"
                                type="text" />
                        </span>
                        <span>
                            Go to :
                            <input
                                class="max-results"
                                [(ngModel)]="pageNumber"
                                (keyup.enter)="jumpToPage(pageNumber)"
                                type="number"
                                [min]="0"
                                [max]="page?.totalPages" />
                        </span>
                        <span (click)="settingsOpened = true" class="clickable" title="Columns settings">
                            <i class="fas fa-cog"></i>
                            @if (!compactMode) {
                                <span>Columns settings</span>
                            }
                        </span>
                        <span (click)="resetColumns()" class="clickable" title="Reset columns">
                            <i class="fas fa-undo-alt"></i>
                            @if (!compactMode) {
                                <span>Reset columns</span>
                            }
                        </span>
                        <span (click)="exportTable()" class="clickable" title="Export as CSV">
                            <i class="fas fa-file-export"></i>
                            @if (!compactMode) {
                                <span>Export CSV</span>
                            }
                        </span>
                    </ng-container>
                </span>
            </th>
        </tr>
    </tbody>
}
<!-- Empty table msg -->
@if (!items || items.length == 0) {
    <tbody>
        <tr>
            @if (!firstLoading) {
                <td [attr.colspan]="nbColumns" class="empty">
                    @if (!isError) {
                        <span>No results</span>
                    }
                    @if (isError) {
                        <span class="error">
                            Error
                            <i class="fas fa-exclamation-circle"></i>
                        </span>
                    }
                    <br />
                    <span class="clickable refresh" (click)="!isLoading ? refresh() : null">
                        Refresh
                        @if (!isLoading) {
                            <span>
                                <i class="fas fa-sync-alt"></i>
                            </span>
                        }
                        @if (isLoading) {
                            <span>
                                <i class="fas fa-sync-alt fa-spin"></i>
                            </span>
                        }
                    </span>
                </td>
            }
            @if (firstLoading && isLoading) {
                <td [attr.colspan]="nbColumns" class="empty">
                    The data is loading
                    <span class="refresh"><i class="fas fa-sync-alt fa-spin"></i></span>
                </td>
            }
        </tr>
    </tbody>
}

@if (settingsOpened) {
    <div class="modal-host">
        <div class="modal-cell">
            <div class="modal-window">
                <div class="header">Table settings</div>
                <div class="body">
                    <table>
                        @for (col of subRowsDefs ? columnDefs.concat(subRowsDefs) : columnDefs; track col) {
                            <tr>
                                <td>{{ col.headerName }}</td>
                                <td>
                                    <checkbox
                                        [(ngModel)]="col.hidden"
                                        [inverse]="true"
                                        (ngModelChange)="saveSettings()"></checkbox>
                                </td>
                                <td><input type="text" [(ngModel)]="col.width" (change)="saveSettings()" /></td>
                            </tr>
                        }
                    </table>
                </div>
                <div class="footer">
                    <button type="button" (click)="resetColumns()">Reset</button>
                    <button type="button" (click)="settingsOpened = false">Close</button>
                </div>
            </div>
        </div>
    </div>
}
